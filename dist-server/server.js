var Os=Object.defineProperty;var Ze=(t,e)=>()=>(t&&(e=t(t=0)),e);var Ls=(t,e)=>{for(var s in e)Os(t,s,{get:e[s],enumerable:!0})};import{createClient as He}from"@supabase/supabase-js";import qe from"dotenv";import Me from"path";import{fileURLToPath as Fs}from"url";var Bs,es,zs,Js,Ee,Pe,Gs,Vs,De,A,Re=Ze(()=>{Bs=Fs(import.meta.url),es=Me.dirname(Bs),zs=Me.join(es,"..",".env"),Js=Me.join(es,".env");qe.config({path:zs});qe.config({path:Js});Ee=process.env.SUPABASE_URL,Pe=process.env.SUPABASE_SERVICE_ROLE_KEY,Gs=process.env.SUPABASE_ANON_KEY;(!Ee||!Pe)&&(console.error("\u274C Error: SUPABASE_URL y SUPABASE_SERVICE_ROLE_KEY deben estar configurados en el archivo .env"),console.error("Por favor, agrega las siguientes variables:"),console.error("SUPABASE_URL=tu_url_de_supabase"),console.error("SUPABASE_SERVICE_ROLE_KEY=tu_service_role_key"),process.exit(1));Vs=He(Ee,Pe,{auth:{autoRefreshToken:!1,persistSession:!1}}),De=He(Ee,Gs||Pe,{auth:{autoRefreshToken:!1,persistSession:!1}}),A=Vs});var ve={};Ls(ve,{SUBSCRIPTION_LIMITS:()=>ke,getSubscriptionLimits:()=>et,getSubscriptionLimitsFromDB:()=>O,groupSelectionService:()=>$e,messageCountService:()=>N,messageLogService:()=>Z,phoneNumberService:()=>qs,subscriptionContactLinksService:()=>oe,subscriptionLimitsService:()=>we,userService:()=>E,validationService:()=>Y});import ge from"fs";import Ce from"path";import{fileURLToPath as Qs}from"url";async function Ys(){try{let{data:t,error:e}=await A.from("users").select("id").limit(1);if(e)throw console.error("\u274C Error conectando a Supabase:",e),e;await ts(),await Xs(),ke=await O(),console.log("\u2705 Base de datos Supabase inicializada correctamente")}catch(t){throw console.error("\u274C Error inicializando base de datos:",t),t}}async function ts(){let{data:t}=await A.from("users").select("*").or("username.eq.admin,email.eq.daviex14@gmail.com").maybeSingle();if(t){if(!t.auth_user_id&&t.email)try{let{data:e,error:s}=await A.auth.admin.listUsers({page:1,perPage:200});if(!s){let o=(e?.users||[]).find(n=>n.email===t.email);o&&await A.from("users").update({auth_user_id:o.id}).eq("id",t.id)}}catch{}}else{let e="daviex14@gmail.com",s=process.env.DEFAULT_ADMIN_PASSWORD||"DxS000DxS*",{data:o,error:n}=await A.auth.admin.createUser({email:e,password:s,email_confirm:!0});if(n){console.error("Error creando usuario admin (auth):",n);return}let{error:i}=await A.from("users").upsert({username:"admin",email:e,auth_user_id:o.user.id,subscription_type:"administrador",subscription_start_date:new Date().toISOString(),subscription_end_date:null,is_active:!0},{onConflict:"auth_user_id"});i?console.error("Error creando usuario admin (public):",i):console.log("\u2705 Usuario admin creado (auth + public)")}}async function Xs(){let{data:t}=await A.from("subscription_limits").select("subscription_type");if(!t||t.length===0){let e=[{subscription_type:"administrador",messages:-1,duration_days:null,price:0},{subscription_type:"gratuito",messages:50,duration_days:30,price:0},{subscription_type:"pro",messages:500,duration_days:30,price:10},{subscription_type:"elite",messages:2e3,duration_days:30,price:15},{subscription_type:"platino",messages:-1,duration_days:30,price:25}],{error:s}=await A.from("subscription_limits").insert(e);s?console.error("Error inicializando l\xEDmites de suscripci\xF3n:",s):console.log("\u2705 L\xEDmites de suscripci\xF3n inicializados")}}async function O(){try{let{data:t,error:e}=await A.from("subscription_limits").select("*");if(e)throw e;let s={};for(let o of t||[])s[o.subscription_type]={messages:o.messages===-1?1/0:o.messages,duration:o.duration_days,price:o.price};return s}catch(t){return console.warn("Error obteniendo l\xEDmites de suscripci\xF3n, usando valores por defecto:",t),{administrador:{messages:1/0,duration:null,price:0},gratuito:{messages:50,duration:30,price:0},pro:{messages:500,duration:30,price:10},elite:{messages:2e3,duration:30,price:15},platino:{messages:1/0,duration:30,price:25}}}}async function et(){return await O()}var Ks,Zs,ke,E,N,xe,os,ss,Hs,Z,Y,we,oe,qs,$e,q=Ze(()=>{Re();Ks=Qs(import.meta.url),Zs=Ce.dirname(Ks),ke={};E={async getCurrentUser(t=null){if(t)return await this.getUserById(t);let{data:e,error:s}=await A.from("users").select("*").or("username.eq.admin,email.eq.daviex14@gmail.com").maybeSingle();return(s||!e)&&(await ts(),e=(await A.from("users").select("*").or("username.eq.admin,email.eq.daviex14@gmail.com").maybeSingle()).data||null),e},async getUserById(t){let{data:e,error:s}=await A.from("users").select("*").eq("id",t).single();return s||!e?null:e},async getUserByUsername(t){let{data:e,error:s}=await A.from("users").select("*").eq("username",t).single();return s||!e?null:e},async getUserByEmail(t){let{data:e,error:s}=await A.from("users").select("*").eq("email",t).maybeSingle();return s||!e?null:e},async ensureProfileForAuthUser(t,e,s){if(!t)throw new Error("authUserId is required");if(!s)throw new Error("email is required");let{data:o,error:n}=await A.from("users").upsert({auth_user_id:t,username:e||s.split("@")[0],email:s,subscription_type:"gratuito",subscription_start_date:new Date().toISOString(),subscription_end_date:null,is_active:!0},{onConflict:"auth_user_id"}).select().single();if(n)throw n;return o},async createUser(t,e,s="gratuito",o=null,n=null,i=null){let a=(await O())[s];if(!a)throw new Error(`Invalid subscription type: ${s}`);let l=n,u=i;if(typeof l=="string"&&l.length===10&&(l=new Date(l+"T00:00:00").toISOString()),l||(l=new Date().toISOString()),u)typeof u=="string"&&u.length===10&&(u=new Date(u+"T00:00:00").toISOString());else if(a.duration){let f=new Date(l);f.setMonth(f.getMonth()+a.duration),u=f.toISOString()}else u=null;if(!e)throw new Error("Email is required");if(!o)throw new Error("Password is required");let{data:c,error:p}=await A.auth.admin.createUser({email:e,password:o,email_confirm:!0});if(p)throw new Error(p.message);let{data:m,error:h}=await A.from("users").upsert({auth_user_id:c.user.id,username:t,email:e,subscription_type:s,subscription_start_date:l,subscription_end_date:u,is_active:!0},{onConflict:"auth_user_id"}).select().single();if(h)throw h;return m},async createUserWithPassword(t,e,s,o="gratuito"){throw new Error("createUserWithPassword is deprecated. Use createUser(username, email, subscriptionType, password, ...)")},async updateUserSubscription(t,e,s=null){let n=(await O())[e];if(!n)throw new Error(`Invalid subscription type: ${e}`);let i=new Date().toISOString(),r=null,a=s!==null?s:n.duration;if(a){let c=new Date;c.setDate(c.getDate()+a),r=c.toISOString()}let{data:l,error:u}=await A.from("users").update({subscription_type:e,subscription_start_date:i,subscription_end_date:r}).eq("id",t).select().single();if(u)throw u;return l},async updateUser(t,e){let{username:s,email:o,password:n,subscriptionType:i,durationDays:r,subscriptionStartDate:a,subscriptionEndDate:l}=e,u={};if(s!==void 0&&(u.username=s),o!==void 0&&(u.email=o),n!==void 0){let h=await this.getUserById(t);if(h?.auth_user_id){let{error:f}=await A.auth.admin.updateUserById(h.auth_user_id,{password:n});if(f)throw new Error(f.message)}else throw new Error("User has no auth_user_id; cannot update password in Auth")}let c=a!==void 0||l!==void 0;if(i!==void 0){let f=(await O())[i];if(!f)throw new Error(`Invalid subscription type: ${i}`);if(u.subscription_type=i,!c){let d=new Date().toISOString(),g=null,y=r??f.duration;if(y){let S=new Date;S.setDate(S.getDate()+y),g=S.toISOString()}u.subscription_start_date=d,u.subscription_end_date=g}}if(a!==void 0&&(u.subscription_start_date=a),l!==void 0&&(typeof l=="string"&&l.length===10?u.subscription_end_date=new Date(l+"T00:00:00").toISOString():u.subscription_end_date=l),Object.keys(u).length===0)return await this.getUserById(t);let{data:p,error:m}=await A.from("users").update(u).eq("id",t).select().single();if(m)throw m;return p},async getAllUsers(){let{data:t,error:e}=await A.from("users").select("*").order("created_at",{ascending:!1});if(e)throw e;return t||[]},async deleteUser(t){let e=await this.getUserById(t);if(!e)return{changes:0};if(e.auth_user_id){let{error:o}=await A.auth.admin.deleteUser(e.auth_user_id);if(o)throw new Error(o.message)}let{error:s}=await A.from("users").delete().eq("id",t);if(s)throw s;return{changes:1}}},N={async getCurrentMonthCount(t){let e=new Date,s=e.getFullYear(),o=e.getMonth()+1,{data:n,error:i}=await A.from("message_counts").select("count").eq("user_id",t).eq("year",s).eq("month",o).single();return i&&i.code!=="PGRST116"&&console.error("Error obteniendo contador de mensajes:",i),n?n.count:0},async incrementCount(t,e=1){let s=new Date,o=s.getFullYear(),n=s.getMonth()+1,{data:i}=await A.from("message_counts").select("count").eq("user_id",t).eq("year",o).eq("month",n).single();if(i){let r=i.count+e,{error:a}=await A.from("message_counts").update({count:r}).eq("user_id",t).eq("year",o).eq("month",n);a&&console.error("Error actualizando contador de mensajes:",a)}else{let{error:r}=await A.from("message_counts").insert({user_id:t,year:o,month:n,count:e});r&&console.error("Error insertando contador de mensajes:",r)}return await this.getCurrentMonthCount(t)},async getMonthlyStats(t,e,s){let{data:o,error:n}=await A.from("message_counts").select("*").eq("user_id",t).eq("year",e).eq("month",s).single();return n&&n.code!=="PGRST116"&&console.error("Error obteniendo estad\xEDsticas mensuales:",n),o||null},async getAllMonthlyStats(t){let{data:e,error:s}=await A.from("message_counts").select("*").eq("user_id",t).order("year",{ascending:!1}).order("month",{ascending:!1});return s?(console.error("Error obteniendo todas las estad\xEDsticas:",s),[]):e||[]}},xe=Ce.join(Zs,"data/local_logs");ge.existsSync(xe)||ge.mkdirSync(xe,{recursive:!0});os=t=>Ce.join(xe,`logs_${t}.json`),ss=t=>{let e=os(t);if(ge.existsSync(e))try{return JSON.parse(ge.readFileSync(e,"utf8"))}catch(s){return console.error(`Error cargando logs locales para ${t}:`,s),[]}return[]},Hs=(t,e)=>{try{let s=os(t);ge.writeFileSync(s,JSON.stringify(e,null,2),"utf8")}catch(s){console.error(`Error guardando logs locales para ${t}:`,s)}},Z={async logMessage(t,e,s,o,n,i=null){let r={id:"local-"+Date.now()+"-"+Math.random().toString(36).substring(2,9),user_id:t,message_type:e||"single",recipient:s||"Desconocido",status:o||"pending",content:n||"",scheduled_at:i,sent_at:new Date().toISOString()};if(t){let a=ss(t);a.push(r),a.length>100&&(a=a.slice(-100)),Hs(t,a)}return r},async getMessageLogs(t,e=100){return t?ss(t).slice(-e):[]}},Y={async validateMessageLimit(t,e=1){let s=await E.getUserById(t);if(!s)return{allowed:!1,reason:"Usuario no encontrado"};let o=await O(),n=(s.subscription_type||"").toString().toLowerCase(),i=o[n]||o[s.subscription_type];if(!i)return{allowed:!1,reason:`Tipo de suscripci\xF3n inv\xE1lido: ${s.subscription_type}`};if(s.subscription_end_date&&i.messages!==1/0&&new Date(s.subscription_end_date)<new Date)return{allowed:!1,reason:"Suscripci\xF3n expirada",subscriptionExpired:!0,currentCount:await N.getCurrentMonthCount(t),limit:i.messages,subscriptionType:s.subscription_type,endDate:s.subscription_end_date};if(i.messages===1/0)return{allowed:!0,reason:null};let r=await N.getCurrentMonthCount(t),a=r+e;return console.log(`[Validation] User ${t}: currentCount=${r}, messageCount=${e}, newCount=${a}, limit=${i.messages}`),a>i.messages?(console.log(`[Validation] BLOCKED: User ${t} would exceed limit (${a} > ${i.messages})`),{allowed:!1,reason:`L\xEDmite de mensajes excedido. Has usado ${r}/${i.messages} mensajes este mes.`,limitExceeded:!0,currentCount:r,limit:i.messages,subscriptionType:s.subscription_type}):(console.log(`[Validation] ALLOWED: User ${t} can send ${e} message(s) (${a} <= ${i.messages})`),{allowed:!0,reason:null})},async canSendMessages(t,e=1){return await this.validateMessageLimit(t,e)},async getSubscriptionInfo(t){let e=await E.getUserById(t);if(!e)return null;let s=await O(),o=(e.subscription_type||"").toString().toLowerCase(),n=s[o]||s[e.subscription_type];if(!n)return{type:e.subscription_type,limit:0,used:await N.getCurrentMonthCount(t),remaining:0,price:0,startDate:e.subscription_start_date,endDate:e.subscription_end_date,isExpired:e.subscription_end_date?new Date(e.subscription_end_date)<new Date:!1};let i=await N.getCurrentMonthCount(t),r=n.messages===1/0?1/0:Math.max(0,n.messages-i);return{type:e.subscription_type,limit:n.messages,used:i,remaining:r,price:n.price,startDate:e.subscription_start_date,endDate:e.subscription_end_date,isExpired:e.subscription_end_date?new Date(e.subscription_end_date)<new Date:!1}}},we={async getAll(){return await O()},async getByType(t){let{data:e,error:s}=await A.from("subscription_limits").select("*").eq("subscription_type",t).single();return s||!e?null:{type:e.subscription_type,messages:e.messages===-1?1/0:e.messages,duration:e.duration_days,price:e.price}},async update(t,e){let{messages:s,duration:o,price:n}=e,r={messages:s===1/0?-1:s,duration_days:o,price:n},{data:a,error:l}=await A.from("subscription_limits").update(r).eq("subscription_type",t).select().single();if(l)throw l;if(!a)throw new Error(`Subscription type ${t} not found`);return ke=await O(),{type:a.subscription_type,messages:a.messages===-1?1/0:a.messages,duration:a.duration_days,price:a.price}}},oe={async getAll(){let{data:t,error:e}=await A.from("subscription_contact_links").select("*");return e?(console.error("Error obteniendo enlaces de contacto:",e),[]):t||[]},async getByType(t){let{data:e,error:s}=await A.from("subscription_contact_links").select("*").eq("subscription_type",t).single();return s||!e?null:{subscriptionType:e.subscription_type,contactType:e.contact_type,contactValue:e.contact_value}},async upsert(t,e,s){let{data:o}=await A.from("subscription_contact_links").select("id").eq("subscription_type",t).single();if(o){let{data:n,error:i}=await A.from("subscription_contact_links").update({contact_type:e,contact_value:s}).eq("subscription_type",t).select().single();if(i)throw i;return{subscriptionType:n.subscription_type,contactType:n.contact_type,contactValue:n.contact_value}}else{let{data:n,error:i}=await A.from("subscription_contact_links").insert({subscription_type:t,contact_type:e,contact_value:s}).select().single();if(i)throw i;return{subscriptionType:n.subscription_type,contactType:n.contact_type,contactValue:n.contact_value}}},async delete(t){let{error:e}=await A.from("subscription_contact_links").delete().eq("subscription_type",t);if(e)throw e;return{changes:1}}},qs={async linkPhoneToUser(t,e){let s=(e||"").replace(/\D/g,"");if(!s)throw new Error("Invalid phone number");let{data:o}=await A.from("user_phone_numbers").select("*").eq("user_id",t).eq("phone_number",s).limit(1).maybeSingle();if(o)return o;let{data:n,error:i}=await A.from("user_phone_numbers").insert({user_id:t,phone_number:s}).select().single();if(i)throw console.error("Error linking phone number to user:",i),i;return n},async countUsersForPhone(t){let e=(t||"").replace(/\D/g,"");if(!e)return 0;let{data:s,error:o}=await A.from("user_phone_numbers").select("user_id").eq("phone_number",e);return o?(console.error("Error counting users for phone number:",o),0):!s||s.length===0?0:new Set(s.map(i=>i.user_id)).size},async countOtherUsersForPhone(t,e){let s=(t||"").replace(/\D/g,"");if(!s)return 0;let{data:o,error:n}=await A.from("user_phone_numbers").select("user_id").eq("phone_number",s).neq("user_id",e);return n?(console.error("Error counting other users for phone number:",n),0):!o||o.length===0?0:new Set(o.map(r=>r.user_id)).size},async unlinkPhoneFromUser(t,e){let s=(e||"").replace(/\D/g,"");if(!s||!t)return!1;let{error:o}=await A.from("user_phone_numbers").delete().eq("user_id",t).eq("phone_number",s);return o?(console.error("Error unlinking phone number from user:",o),!1):(console.log(`Phone ${s} unlinked from user ${t}`),!0)}},$e={async getByUserId(t){let{data:e,error:s}=await A.from("group_selections").select("*").eq("user_id",t).order("created_at",{ascending:!1});return s?(console.error("Error obteniendo selecciones de grupos:",s),[]):(e||[]).map(o=>({id:o.id.toString(),name:o.name,description:o.description||"",groupIds:JSON.parse(o.group_ids),createdAt:new Date(o.created_at)}))},async getById(t,e){let{data:s,error:o}=await A.from("group_selections").select("*").eq("id",t).eq("user_id",e).single();return o||!s?null:{id:s.id.toString(),name:s.name,description:s.description||"",groupIds:JSON.parse(s.group_ids),createdAt:new Date(s.created_at)}},async create(t,e,s,o){let{data:n,error:i}=await A.from("group_selections").insert({user_id:t,name:e,description:s||null,group_ids:JSON.stringify(o)}).select().single();if(i)throw i;return{id:n.id.toString(),name:n.name,description:n.description||"",groupIds:JSON.parse(n.group_ids),createdAt:new Date(n.created_at)}},async update(t,e,s){let{name:o,description:n,groupIds:i}=s,r={};if(o!==void 0&&(r.name=o),n!==void 0&&(r.description=n||null),i!==void 0&&(r.group_ids=JSON.stringify(i)),Object.keys(r).length===0)return await this.getById(t,e);let{data:a,error:l}=await A.from("group_selections").update(r).eq("id",t).eq("user_id",e).select().single();if(l)throw l;return{id:a.id.toString(),name:a.name,description:a.description||"",groupIds:JSON.parse(a.group_ids),createdAt:new Date(a.created_at)}},async delete(t,e){let{error:s}=await A.from("group_selections").delete().eq("id",t).eq("user_id",e);if(s)throw s;return{changes:1}}};Ys().catch(t=>{console.error("Error inicializando base de datos:",t)})});import _e from"express";import{createServer as Wt}from"http";import{Server as Ts}from"socket.io";import Ft from"cors";import Bt from"dotenv";import Ve from"path";import{fileURLToPath as zt}from"url";import Qe from"fs";import Ws from"net";function Se(t){return new Promise(e=>{let s=Ws.createServer();s.listen(t,()=>{s.once("close",()=>{e(!0)}),s.close()}),s.on("error",()=>{e(!1)})})}var Ye=new Set([3e3,3001,5173,5174,5175,8e3,8080,5e3,4e3,9e3,3002,3003,3004,3005,3006,3007,3008,3009,8001,8002,8003,8081,8082,8083,5001,5002,5003,4001,4002,4003,9001,9002,9003]);async function Xe(t,e=null){let n=Math.max(1,Math.min(65535,t)),i=65535-n+1,r=e!==null?Math.min(e,i):i,a=0;for(let l=0;l<r&&a<r;l++){let u=n+l;if(u>65535)break;if(Ye.has(u))continue;if(a++,await Se(u))return u}if(e===null&&n>1)for(let l=1;l<n;l++){if(Ye.has(l))continue;if(await Se(l))return l}throw new Error(`No available port found starting from ${t} (checked ${a} ports, skipping common ports)`)}import st from"qrcode";import{v4 as ns}from"uuid";import j from"fs";import P from"path";import{fileURLToPath as tt}from"url";import{EventEmitter as ot}from"events";import nt,{useMultiFileAuthState as rt,fetchLatestBaileysVersion as it,DisconnectReason as rs}from"@whiskeysockets/baileys";var at=tt(import.meta.url),L=P.dirname(at),is=()=>{let t=process.env.SESSION_DIR;return t&&t.trim()?P.resolve(t.trim()):P.join(L,".baileys_auth")},as=t=>t?t.replace("@s.whatsapp.net","").replace("@c.us",""):"Desconocido",Te=class extends ot{constructor(e,s=null,o=null){super(),this.io=e,this.authDir=s||is(),this.sessionId=o,this.client=null,this.sock=null,this.contactsCache={},this.isReady=!1,this.qrCode=null,this.qrDataUrl=null,this.autoReplyRules=[],this.interactiveMenus=[],this.userSessions=new Map,this.sessionTimeout=900*1e3,this.activeUserId=null,this.config={headless:!0,messageDelay:2,maxContactsPerBatch:50,waitTimeBetweenBatches:15},this.bulkControllers=new Map,this.globalSessionsEnabled=!0,this._initializePromise=null,this._reconnectTimer=null,this._reconnectAttempts=0,this._autoResetInProgress=!1,this._lastAutoResetAt=0,this.loadAutoReplyRules(),this.loadInteractiveMenus(),this.loadUserSessions(),this.loadConfig(),this.loadGlobalSessionsConfig()}loadGlobalSessionsConfig(){try{let e=process.env.DATA_DIR||P.join(L,"data"),s=P.join(e,"globalSessionsConfig.json");if(j.existsSync(s)){let o=JSON.parse(j.readFileSync(s,"utf8"));this.globalSessionsEnabled=o.enabled??!0,this.activeSessionId=o.activeSessionId??null,console.log("[WhatsApp] Global sessions config loaded:",{enabled:this.globalSessionsEnabled,activeSessionId:this.activeSessionId,thisSessionId:this.sessionId})}else this.globalSessionsEnabled=!0,this.activeSessionId=null}catch(e){console.error("[WhatsApp] Error loading global sessions config:",e),this.globalSessionsEnabled=!0}}scheduleReconnect(e){try{this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._reconnectTimer=setTimeout(()=>{this.initialize().catch(()=>{})},Math.max(0,e||0))}catch{}}clearReconnectTimer(){try{this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null)}catch{}}async setActiveUserId(e){if(this.activeUserId=e,this.isReady&&e)try{let{userService:s,phoneNumberService:o}=await Promise.resolve().then(()=>(q(),ve));if(((await s.getUserById(e))?.subscription_type||"").toString().toLowerCase()==="administrador"){console.log(`[WhatsApp] User ${e} is admin, skipping phone number registration`);return}let r=this.sock?.user?.id||this.sock?.user?.jid;if(r){let u=r.split("@")[0].split(":")[0].replace(/\D/g,"");if(u){if(await o.countOtherUsersForPhone(u,e)>=2){await o.unlinkPhoneFromUser(e,u),this.io&&(this.io.emit("phone_limit_exceeded",{phone:u,userId:e,message:"Este n\xFAmero de WhatsApp ya est\xE1 sincronizado con el m\xE1ximo de cuentas permitidas (2)."}),this.io.emit("disconnected",{reason:"phone_limit_exceeded"})),await this.destroy();return}await o.linkPhoneToUser(e,u),console.log(`[WhatsApp] Phone ${u} linked to user ${e} (session already active)`)}}}catch(s){console.error("Error linking phone on user change:",s)}}async checkAndAutoInitialize(){try{let e=P.join(L,".baileys_auth");j.existsSync(e)&&j.readdirSync(e).length>0&&(console.log("\u{1F4F1} Sesi\xF3n Baileys detectada. Intentando reconexi\xF3n autom\xE1tica..."),setTimeout(async()=>{try{await this.initialize(),console.log("\u2705 Auto-inicializaci\xF3n completada")}catch(o){console.error("\u274C Error en auto-inicializaci\xF3n:",o.message)}},2e3))}catch(e){console.error("Error verificando sesi\xF3n guardada:",e)}}loadAutoReplyRules(){try{let e=process.env.DATA_DIR||P.join(L,"data"),s=this.sessionId?`autoReplyRules_${this.sessionId}.json`:"autoReplyRules.json",o=P.join(e,s);if(!j.existsSync(o)&&this.sessionId){let n=P.join(e,"autoReplyRules.json");if(j.existsSync(n))try{j.copyFileSync(n,o),console.log(`[WhatsApp] Copied global auto-reply rules to session ${this.sessionId}`)}catch(i){console.warn("[WhatsApp] Failed to copy global auto-reply rules:",i)}}if(j.existsSync(o)){let n=JSON.parse(j.readFileSync(o,"utf8"));this.autoReplyRules=n.map(i=>{if(i.keywords&&typeof i.keywords=="string")try{i.keywords=JSON.parse(i.keywords)}catch{i.keywords=i.keywords.split(",").map(r=>r.trim()).filter(r=>r.length>0)}return Array.isArray(i.keywords)||(i.keywords=[]),i})}else this.autoReplyRules=[{id:"1",name:"Saludo B\xE1sico",keywords:["hola","buenas","info"],response:"\xA1Hola! Gracias por escribirnos. \xBFEn qu\xE9 podemos ayudarte hoy?",matchType:"contains",delay:2,isActive:!0}],this.saveAutoReplyRules()}catch(e){console.error("Error loading auto-reply rules:",e),this.autoReplyRules=[]}}saveAutoReplyRules(){try{let e=process.env.DATA_DIR||P.join(L,"data"),s=this.sessionId?`autoReplyRules_${this.sessionId}.json`:"autoReplyRules.json",o=P.join(e,s);j.existsSync(e)||j.mkdirSync(e,{recursive:!0}),j.writeFileSync(o,JSON.stringify(this.autoReplyRules,null,2))}catch(e){console.error("Error saving auto-reply rules:",e)}}loadInteractiveMenus(){try{let e=process.env.DATA_DIR||P.join(L,"data"),s=this.sessionId?`interactiveMenus_${this.sessionId}.json`:"interactiveMenus.json",o=P.join(e,s);if(!j.existsSync(o)&&this.sessionId){let n=P.join(e,"interactiveMenus.json");if(j.existsSync(n))try{j.copyFileSync(n,o),console.log(`[WhatsApp] Copied global interactive menus to session ${this.sessionId}`)}catch(i){console.warn("[WhatsApp] Failed to copy global interactive menus:",i)}}j.existsSync(o)?(this.interactiveMenus=JSON.parse(j.readFileSync(o,"utf8")),console.log(`[WhatsApp] Loaded ${this.interactiveMenus.length} interactive menus`)):(this.interactiveMenus=[],this.saveInteractiveMenus())}catch(e){console.error("Error loading interactive menus:",e),this.interactiveMenus=[]}}saveInteractiveMenus(){try{let e=process.env.DATA_DIR||P.join(L,"data"),s=this.sessionId?`interactiveMenus_${this.sessionId}.json`:"interactiveMenus.json",o=P.join(e,s);j.existsSync(e)||j.mkdirSync(e,{recursive:!0}),j.writeFileSync(o,JSON.stringify(this.interactiveMenus,null,2)),console.log(`[WhatsApp] Saved ${this.interactiveMenus.length} interactive menus`)}catch(e){console.error("Error saving interactive menus:",e)}}loadUserSessions(){try{let e=process.env.DATA_DIR||P.join(L,"data"),s=P.join(e,"userSessions.json");if(j.existsSync(s)){let o=JSON.parse(j.readFileSync(s,"utf8"));this.userSessions=new Map(o.map(n=>[n.userId,n])),console.log(`[WhatsApp] Loaded ${this.userSessions.size} user sessions`),this.cleanExpiredSessions()}else this.userSessions=new Map}catch(e){console.error("Error loading user sessions:",e),this.userSessions=new Map}}saveUserSessions(){try{let e=process.env.DATA_DIR||P.join(L,"data");j.existsSync(e)||j.mkdirSync(e,{recursive:!0});let s=P.join(e,"userSessions.json"),o=Array.from(this.userSessions.values());j.writeFileSync(s,JSON.stringify(o,null,2))}catch(e){console.error("Error saving user sessions:",e)}}cleanExpiredSessions(){let e=Date.now(),s=0;for(let[o,n]of this.userSessions.entries()){let i=new Date(n.lastInteraction).getTime();e-i>this.sessionTimeout&&(this.userSessions.delete(o),s++)}s>0&&(console.log(`[WhatsApp] Cleaned ${s} expired sessions`),this.saveUserSessions())}getSession(e){let s=this.userSessions.get(e);if(!s)return null;let o=new Date(s.lastInteraction).getTime();return Date.now()-o>this.sessionTimeout?(this.userSessions.delete(e),this.saveUserSessions(),null):s}setSession(e,s,o={}){let n={userId:e,currentMenuId:s,history:[],conversationData:o,startTime:new Date().toISOString(),lastInteraction:new Date().toISOString()};return this.userSessions.set(e,n),this.saveUserSessions(),n}updateSession(e,s,o=null){let n=this.userSessions.get(e);n&&(n.currentMenuId!==s&&(n.history=n.history||[],n.history.push(n.currentMenuId),n.history.length>20&&n.history.shift()),n.currentMenuId=s,n.lastInteraction=new Date().toISOString(),o!==null&&(n.conversationData={...n.conversationData,...o}),this.userSessions.set(e,n),this.saveUserSessions())}clearSession(e){this.userSessions.delete(e),this.saveUserSessions()}async handleMenuInteraction(e,s,o,n,i,r){try{let a=this.interactiveMenus.find(u=>u.id===o.currentMenuId);if(!a||!a.isActive)return console.log("[WhatsApp] Current menu not found or inactive, clearing session"),this.clearSession(e),!1;let l=a.options.find(u=>u.triggers.some(c=>s.toLowerCase().trim()===c.toLowerCase().trim()||s.toLowerCase().includes(c.toLowerCase())));if(!l){let u=a.options&&a.options.length>0?a.options.map((c,p)=>{let m=c.triggers&&c.triggers.length>0?c.triggers[0]:(p+1).toString();return/^\d+$/.test(m)?`${m}\uFE0F\u20E3 ${c.label}`:c.label}).join(`
`):"";return await this.sendMessage(e,`\u274C Opci\xF3n no v\xE1lida. Por favor, elige una opci\xF3n del men\xFA:

${u}`),!0}if(console.log("[WhatsApp] Menu option matched:",{userId:e,menuId:a.id,optionId:l.id,optionLabel:l.label,nextMenuId:l.nextMenuId,goBack:!!l.goBack,endConversation:!!l.endConversation,hasResponse:!!l.response,mediaCount:(l.mediaPaths||[]).length}),l.response||l.mediaPaths&&l.mediaPaths.length>0){let u=l.mediaPaths||[],c=l.captions||[];await this.sendMessage(e,l.response||"",u,c),n&&n.id&&(await i.incrementCount(n.id,1),await r.logMessage(n.id,"menu-response",e,"sent",`Menu response: ${l.label}`,null))}if(console.log("[WhatsApp] Starting navigation check for option:",l.label),l.endConversation)this.clearSession(e),console.log("[WhatsApp] Conversation ended for user:",e);else if(l.goBack){let u=o.history||[],c=u.length>0?u.pop():null;if(c){let p=this.interactiveMenus.find(m=>String(m.id)===String(c)&&m.isActive);p?(await this.sendMenu(e,p),o.currentMenuId=c,o.history=u,o.lastInteraction=new Date().toISOString(),this.userSessions.set(e,o),this.saveUserSessions(),console.log("[WhatsApp] Go back to menu:",{userId:e,toMenu:c})):await this.sendMessage(e,"\u274C El men\xFA anterior ya no est\xE1 disponible.")}else await this.sendMessage(e,"\u274C No hay un men\xFA anterior al que volver.")}else if(l.nextMenuId){let u=this.interactiveMenus.find(c=>String(c.id)===String(l.nextMenuId)&&c.isActive);u?(await this.sendMenu(e,u),this.updateSession(e,u.id),n&&n.id&&await i.incrementCount(n.id,1),console.log("[WhatsApp] Navigated to menu:",{userId:e,fromMenu:a.id,toMenu:u.id})):(this.clearSession(e),console.log("[WhatsApp] Next menu not found, ending conversation"))}else this.updateSession(e,a.id);return!0}catch(a){return console.error("[WhatsApp] Error handling menu interaction:",a),this.clearSession(e),!1}}loadConfig(){try{let e=process.env.DATA_DIR||P.join(L,"data"),s=P.join(e,"config.json");j.existsSync(s)&&(this.config=JSON.parse(j.readFileSync(s,"utf8")))}catch(e){console.error("Error loading config:",e)}}saveConfig(){try{let e=process.env.DATA_DIR||P.join(L,"data");j.existsSync(e)||j.mkdirSync(e,{recursive:!0});let s=P.join(e,"config.json");j.writeFileSync(s,JSON.stringify(this.config,null,2))}catch(e){console.error("Error saving config:",e)}}getQrCode(){return this.qrDataUrl}resolveJid(e){return e.includes("@")?e:`${e.replace(/\D/g,"")}@s.whatsapp.net`}getTextFromMessage(e){let s=e.message||{};return s.conversation||s.extendedTextMessage?.text||s.imageMessage?.caption||s.videoMessage?.caption||""}getBulkController(e){let s=e||"global";return this.bulkControllers.has(s)||this.bulkControllers.set(s,{cancelled:!1,paused:!1}),this.bulkControllers.get(s)}pauseBulk(e=null){let s=this.getBulkController(e);s.paused=!0,s.cancelled=!1,this.io&&this.io.emit("bulk_control",{userId:e||null,action:"paused"})}resumeBulk(e=null){let s=this.getBulkController(e);s.paused=!1,this.io&&this.io.emit("bulk_control",{userId:e||null,action:"resumed"})}cancelBulk(e=null){let s=this.getBulkController(e);if(s.cancelled=!0,s.paused=!1,this.io){let o=e||null;this.io.emit("bulk_control",{userId:o,action:"cancelled"}),this.io.emit("bulk_progress",{userId:o,current:0,total:0,status:"cancelled",batch:0,totalBatches:0})}}clearBulk(e=null){let s=e||"global";this.bulkControllers.has(s)&&this.bulkControllers.delete(s)}async sleepWithControl(e,s){let n=0;for(;n<e&&!s.cancelled;){for(;s.paused&&!s.cancelled;)await new Promise(a=>setTimeout(a,500));if(s.cancelled)break;let i=e-n,r=Math.min(500,i);await new Promise(a=>setTimeout(a,r)),n+=r}}async initialize(){if(this._initializePromise)return this._initializePromise;this._initializePromise=(async()=>{console.log("Inicializando cliente WhatsApp (Baileys)..."),this.clearReconnectTimer();try{if(this.sock){try{this.sock.ws?.close?.()}catch{}try{this.sock.end?.()}catch{}}}catch{}let e=this.authDir;j.existsSync(e)||j.mkdirSync(e,{recursive:!0});let{state:s,saveCreds:o}=await rt(e),{version:n}=await it();return this.sock=nt({version:n,auth:s,printQRInTerminal:!1,browser:["WhatyBot","Chrome","1.0.0"],markOnlineOnConnect:!1,shouldIgnoreJid:i=>i?!!(i==="status@broadcast"||i.endsWith("@broadcast")):!1}),this.client=this.sock,this.sock.ev.on("creds.update",o),this.sock.ev.on("connection.update",async i=>{this.emit("connection.update",i);let{connection:r,qr:a,lastDisconnect:l}=i;if(a)try{this.qrCode=a;let u=await st.toDataURL(a);this.qrDataUrl=u,this.io.emit("qr",{sessionId:this.sessionId,qr:u})}catch{}if(r==="open"){this.isReady=!0,this.qrCode=null,this.qrDataUrl=null,this._reconnectAttempts=0,this.clearReconnectTimer();let u=null;try{let c=this.sock?.user?.id||this.sock?.user?.jid;if(c&&(u=c.split("@")[0].split(":")[0].replace(/\D/g,"")),u&&this.activeUserId){let{userService:p,phoneNumberService:m}=await Promise.resolve().then(()=>(q(),ve));if(((await p.getUserById(this.activeUserId))?.subscription_type||"").toString().toLowerCase()==="administrador")console.log(`[WhatsApp] User ${this.activeUserId} is admin, skipping phone number registration`);else{if(await m.countOtherUsersForPhone(u,this.activeUserId)>=2){await m.unlinkPhoneFromUser(this.activeUserId,u),this.io&&(this.io.emit("phone_limit_exceeded",{phone:u,userId:this.activeUserId,sessionId:this.sessionId,message:"Este n\xFAmero de WhatsApp ya est\xE1 sincronizado con el m\xE1ximo de cuentas permitidas (2)."}),this.io.emit("disconnected",{reason:"phone_limit_exceeded"})),await this.destroy();return}await m.linkPhoneToUser(this.activeUserId,u)}}}catch(c){console.error("Error validating phone number usage:",c)}this.io?.emit("authenticated",{sessionId:this.sessionId,phone:u}),this.io?.emit("ready",{sessionId:this.sessionId,status:"connected",phone:u})}else if(r==="close"){this.isReady=!1;let u=l?.error?.output?.statusCode,c=u===rs.loggedOut;if(this.io.emit("disconnected",{sessionId:this.sessionId,reason:c?"logged_out":"connection_closed"}),c){let p=Date.now(),m=60*1e3;if(!this._autoResetInProgress&&p-(this._lastAutoResetAt||0)>m){this._autoResetInProgress=!0,this._lastAutoResetAt=p;try{console.log("\u{1F501} Sesi\xF3n inv\xE1lida (logged_out). Limpiando sesi\xF3n y generando nuevo QR autom\xE1ticamente..."),await this.resetSession()}catch(h){console.error("\u274C Error auto-reseteando sesi\xF3n:",h?.message||h);try{await this.destroy()}catch{}}finally{this._autoResetInProgress=!1}}else this._autoResetInProgress?console.log("\u26A0\uFE0F Auto-reset ya en progreso, ignorando evento logged_out duplicado."):console.log("\u23F3 Auto-reset en enfriamiento (cooldown), esperando...");this.clearReconnectTimer(),this._reconnectAttempts=0;return}if(u!==rs.loggedOut)if(String(l?.error)?.includes("Stream Errored (conflict)"))console.log("[WhatsApp] Conflict detected (Stream Errored), waiting 5s before reconnect..."),this.scheduleReconnect(5e3);else{this._reconnectAttempts=(this._reconnectAttempts||0)+1;let f=Math.min(6e4,2e3*2**Math.min(6,this._reconnectAttempts-1));console.log(`[WhatsApp] Reconnecting in ${f}ms (attempt ${this._reconnectAttempts})...`),this.scheduleReconnect(f)}}}),this.sock.ev.on("messages.upsert",async({messages:i})=>{try{let r=i&&i[0];if(!r)return;let a=r.key.remoteJid||"";if(a==="status@broadcast"||a.endsWith("@broadcast"))return;let l=a.endsWith("@g.us"),u=!!r.key.fromMe;if(u)return;let c=this.config?.autoReplyInGroups||!1;if(l&&!c){console.log("[WhatsAppClient] Skipping group message (autoReplyInGroups disabled)");return}let p=a,m=(this.getTextFromMessage(r)||"").toLowerCase(),h=this.activeUserId?`[Usuario activo: ${this.activeUserId}]`:"[Usuario activo: NINGUNO]";console.log(`${h} Message received:`,{from:p,body:m.substring(0,100)||"(sin texto)",isGroup:l,fromMe:u});let{userService:f,validationService:d,messageCountService:g,messageLogService:y}=await Promise.resolve().then(()=>(q(),ve)),S=null;try{this.activeUserId&&(S=await f.getUserById(this.activeUserId),S&&S.is_active||(S=null))}catch{}if(S&&S.id){let w=`[Usuario: ${S.id} - ${S.username||S.email||"N/A"}]`,I=await d.canSendMessages(S.id,1);if(!I.allowed){this.io&&this.io.emit("limit_exceeded",{userId:S.id,limitExceeded:I.limitExceeded,currentCount:I.currentCount,limit:I.limit,subscriptionType:I.subscriptionType});return}}if(!this.globalSessionsEnabled){if(this.sessionId!==this.activeSessionId){console.log(`[WhatsApp] \u26D4 SKIP: Session ${this.sessionId} is NOT active. Active is: ${this.activeSessionId}`);return}console.log(`[WhatsApp] \u2705 PROCESS: Session ${this.sessionId} IS active.`)}let v=this.getSession(p);if(v){let w=this.interactiveMenus.find(I=>String(I.id)===String(v.currentMenuId));if(!w||!w.isActive)console.log("[WhatsApp] Menu session exists but menu is inactive/deleted, clearing session"),this.clearSession(p);else{let I=this.autoReplyRules.find(_=>_.type==="menu"&&String(_.menuId)===String(v.currentMenuId));if(I&&!I.isActive)console.log("[WhatsApp] Menu session exists but auto-reply trigger is inactive, clearing session"),this.clearSession(p);else if(await this.handleMenuInteraction(p,m,v,S,g,y))return}}console.log(`[WhatsApp] Checking ${this.autoReplyRules.length} auto-reply rules...`);for(let w of this.autoReplyRules){if(!w.isActive||w.type!=="menu")continue;let I=m.trim(),_=!1;if(w.matchType==="exact"?_=w.keywords.some(b=>I===b.toLowerCase().trim()):w.matchType==="contains"&&(_=w.keywords.some(b=>I.includes(b.toLowerCase().trim()))),console.log(`[WhatsApp] Rule [${w.name}] match result: ${_} (Keywords: ${w.keywords.join(",")}, Input: ${I})`),_&&w.menuId){let b=this.interactiveMenus.find(M=>String(M.id)===String(w.menuId)&&M.isActive);if(b){console.log("[WhatsAppClient] Starting menu session:",{userId:p,menuId:b.id,menuName:b.name}),await new Promise(M=>setTimeout(M,w.delay*1e3)),await this.sendMenu(p,b),this.setSession(p,b.id),S&&S.id&&(await g.incrementCount(S.id,1),await y.logMessage(S.id,"menu-start",p,"sent",`Menu started: ${b.name}`,null)),this.io&&this.io.emit("message_log",{id:Date.now().toString(),sessionId:this.sessionId,userId:S?.id||null,target:p,status:"sent",timestamp:new Date,content:`Menu started: ${b.name}`,messageType:"menu-start"});return}}}for(let w of this.autoReplyRules){if(!w.isActive||w.type==="menu")continue;let I=m,_=!1;if(w.matchType==="exact"?_=w.keywords.some(b=>I===b.toLowerCase()):w.matchType==="contains"&&(_=w.keywords.some(b=>I.includes(b.toLowerCase()))),_){let b=w.response||"",M=Array.isArray(w.mediaPaths)?w.mediaPaths.filter(Boolean):w.mediaPath?[w.mediaPath]:[],D=Array.isArray(w.captions)?w.captions:M.map(()=>w.caption||"");console.log("[WhatsAppClient] Auto-reply matched rule:",{id:w.id,name:w.name,mediaPaths:M,captions:D}),await new Promise(k=>setTimeout(k,w.delay*1e3));try{await this.sendMessage(p,b,M,D);let k=as(p);this.io&&this.io.emit("message_log",{id:ns(),sessionId:this.sessionId,userId:S?.id||null,target:k,status:"sent",timestamp:new Date,content:`Auto-reply: ${b||"[Archivo multimedia]"}`,messageType:"auto-reply"}),S&&S.id&&(await g.incrementCount(S.id,1),await y.logMessage(S.id,"auto-reply",k,"sent",`Auto-reply: ${b||"[Archivo multimedia]"}`,null))}catch(k){console.error("[WhatsAppClient] Error sending auto-reply:",k);let G=as(p);this.io&&this.io.emit("message_log",{id:ns(),sessionId:this.sessionId,userId:S?.id||null,target:G,status:"failed",timestamp:new Date,content:`Auto-reply: ${b||"[Archivo multimedia]"}`,messageType:"auto-reply"}),S&&S.id&&await y.logMessage(S.id,"auto-reply",G,"failed",`Auto-reply: ${b||"[Archivo multimedia]"}`,null)}break}}}catch{}}),this.sock.ev.on("contacts.upsert",(i=[])=>{try{i.forEach(r=>{r&&r.id&&(this.contactsCache[r.id]={id:r.id,name:r.name||r.notify,status:r.status})})}catch{}}),this.sock.ev.on("contacts.update",(i=[])=>{try{i.forEach(r=>{let a=r?.id;if(!a)return;let l=this.contactsCache[a]||{id:a};this.contactsCache[a]={...l,name:r.name||l.name,status:r.status||l.status}})}catch{}}),this.sock.ev.on("chats.upsert",(i=[])=>{try{i.forEach(r=>{let a=r?.id;if(a&&a.endsWith("@s.whatsapp.net")){let l=r.name||r.subject||r.notify||a.split("@")[0];this.contactsCache[a]={id:a,name:l}}})}catch{}}),!0})();try{return await this._initializePromise}finally{this._initializePromise=null}}async sendMenu(e,s){if(!s)return;let o=s.options&&s.options.length>0?`

`+s.options.map((a,l)=>{let u=a.triggers&&a.triggers.length>0?a.triggers[0]:(l+1).toString();return/^\d+$/.test(u)?`${u}\uFE0F\u20E3 ${a.label}`:a.label}).join(`
`):"",n=s.mediaPaths||[],i=(s.captions||[]).slice(),r=s.message||"";return!r&&i.length>0?i[0]=(i[0]||"")+o:r=(r||"")+o,console.log("[WhatsApp] Sending menu:",{jid:e,menuName:s.name,optionsCount:(s.options||[]).length,mediaCount:n.length,finalMessageSnippet:r.substring(0,50)+"...",firstCaptionSnippet:i.length>0?(i[0]||"").substring(0,50)+"...":"N/A"}),console.log("[WhatsApp] Generated options list:",o),this.sendMessage(e,r,n,i)}async sendMessage(e,s="",o=null,n=""){if(!this.sock)throw new Error("WhatsApp client no est\xE1 inicializado");if(!this.isReady)throw new Error("WhatsApp client no est\xE1 listo");try{let i=this.resolveJid(e),r=o?Array.isArray(o)?o.filter(Boolean):[o]:[],a=Array.isArray(n)?n:r.map(()=>n||"");if(s&&s.trim())try{await this.sock.sendMessage(i,{text:s})}catch(l){throw i.endsWith("@g.us")&&(l.message.includes("not authorized")||l.message.includes("403")||l.message.includes("401"))?new Error("No tienes permiso para enviar mensajes a este grupo (solo administradores)"):l}for(let l=0;l<r.length;l++){let u=r[l];if(!u)continue;let c=a[l]||"",p=u.replace(/\\/g,"/"),m=P.isAbsolute(p)?p:P.join(L,p);if(console.log("[sendMessage] Media file debug:",{currentPath:u,normalizedPath:p,__dirname:L,absolutePath:m,exists:j.existsSync(m)}),!j.existsSync(m)){console.error(`[sendMessage] File not found: ${m}`),console.error(`[sendMessage] Tried to find file from path: ${u}`);continue}let h=P.extname(m).toLowerCase(),f=j.readFileSync(m);try{[".jpg",".jpeg",".png",".gif",".webp"].includes(h)?await this.sock.sendMessage(i,{image:f,caption:c||void 0}):[".mp4",".mov",".avi",".mkv",".webm"].includes(h)?await this.sock.sendMessage(i,{video:f,caption:c||void 0}):[".mp3",".wav",".ogg",".m4a"].includes(h)?await this.sock.sendMessage(i,{audio:f}):await this.sock.sendMessage(i,{document:f,fileName:P.basename(u)})}catch(d){throw i.endsWith("@g.us")&&(d.message.includes("not authorized")||d.message.includes("403")||d.message.includes("401"))?new Error("No tienes permiso para enviar mensajes a este grupo (solo administradores)"):d}try{this.io&&r.length>0&&this.io.emit("media_progress",{userId:this.activeUserId||null,current:l+1,total:r.length,contact:e,status:"sent",batch:1,totalBatches:1})}catch{}}return{success:!0}}catch(i){throw i}}async sendBulkMessages(e,s="",o=null,n="",i=2,r=null,a=null,l=null){if(!this.sock||!this.isReady)throw new Error("WhatsApp client no est\xE1 listo");let u=a||this.config.maxContactsPerBatch||50,c=l||this.config.waitTimeBetweenBatches||15,p=i||this.config.messageDelay||2,m=[],h=e.length,f=0,d=0,g=0,y=this.getBulkController(r);y.cancelled=!1,y.paused=!1;let S={};if(e.some(w=>w.phone&&(w.phone.endsWith("@g.us")||w.phone.includes("-"))))try{S=await this.sock.groupFetchAllParticipating()}catch(w){console.warn("[WhatsApp] Error fetching groups for validation:",w.message)}let v=[];for(let w=0;w<e.length;w+=u)v.push(e.slice(w,w+u));console.log(`\u{1F4E6} Enviando ${h} contactos en ${v.length} lote(s) de m\xE1ximo ${u} contactos cada uno`);for(let w=0;w<v.length;w++){let I=v[w];console.log(`\u{1F4E4} Procesando lote ${w+1}/${v.length} (${I.length} contactos)`);for(let _=0;_<I.length;_++){if(y.cancelled){console.log(`\u{1F6AB} Env\xEDo masivo cancelado para usuario ${r||"N/A"} durante el lote ${w+1}`);break}for(;y.paused&&!y.cancelled;)await new Promise(M=>setTimeout(M,500));if(y.cancelled){console.log(`\u{1F6AB} Env\xEDo masivo cancelado para usuario ${r||"N/A"} antes de enviar contacto en lote ${w+1}`);break}let b=I[_];try{let M=s||"",D=n,k=null;Object.keys(b).forEach(te=>{let ie=new RegExp(`{{${te}}}`,"g");M=M.replace(ie,b[te]),typeof D=="string"&&(D=D.replace(ie,b[te]))}),Array.isArray(n)&&(k=n.map(te=>{let ie=te||"";return Object.keys(b).forEach(Ke=>{let Ns=new RegExp(`{{${Ke}}}`,"g");ie=ie.replace(Ns,b[Ke])}),ie}));let G=Array.isArray(n)?k:D;if(await this.sendMessage(b.phone,M,o,G),m.push({contact:b.phone,status:"sent",timestamp:new Date}),f++,d++,this.io.emit("bulk_progress",{userId:r||null,current:f,total:h,successCount:d,failedCount:g,contact:b.phone,status:"sent",batch:w+1,totalBatches:v.length}),_<I.length-1){let te=Math.floor(Math.random()*(p-1)*1e3)+1e3;await this.sleepWithControl(te,y)}}catch(M){console.error(`Error sending to ${b.phone}:`,M),m.push({contact:b.phone,status:"failed",error:M.message,timestamp:new Date}),f++,g++,this.io.emit("bulk_progress",{userId:r||null,current:f,total:h,successCount:d,failedCount:g,contact:b.phone,status:"failed",batch:w+1,totalBatches:v.length})}}if(y.cancelled)break;if(w<v.length-1){let _=c*60*1e3;if(console.log(`\u23F3 Esperando ${c} minutos antes del siguiente lote...`),this.io.emit("bulk_progress",{userId:r||null,current:f,total:h,status:"waiting",batch:w+1,totalBatches:v.length,waitMinutes:c}),await this.sleepWithControl(_,y),y.cancelled){console.log(`\u{1F6AB} Env\xEDo masivo cancelado para usuario ${r||"N/A"} durante la espera entre lotes`);break}console.log("\u2705 Espera completada, continuando con el siguiente lote...")}if(y.cancelled)break}return y.cancelled?console.log(`\u2705 Env\xEDo masivo detenido: ${m.filter(w=>w.status==="sent").length} exitosos, ${m.filter(w=>w.status==="failed").length} fallidos (cancelado por usuario)`):console.log(`\u2705 Env\xEDo masivo completado: ${m.filter(w=>w.status==="sent").length} exitosos, ${m.filter(w=>w.status==="failed").length} fallidos`),this.clearBulk(r),m}async getGroups(){if(!this.sock||!this.isReady)throw new Error("WhatsApp client no est\xE1 listo");try{let e=this.sock?.user?.id||this.sock?.user?.jid||"",s=this.sock?.user?.lid||this.sock?.user?.lidJid||this.sock?.user?.userLid||"",o=e?e.split("@")[0].split(":")[0]:"",n=o?`${o}@s.whatsapp.net`:"",i=c=>!c||typeof c!="string"?"":c.split("@")[0].split(":")[0].replace(/\D/g,""),r=c=>!c||typeof c!="string"?"":c.split("@")[0].split(":")[0].replace(/\D/g,""),a=s?`${r(s)}@lid`:"",l=await this.sock.groupFetchAllParticipating(),u=Object.values(l||{});return await Promise.all(u.map(async c=>{let p=null;try{p=await this.sock.profilePictureUrl(c.id,"image")}catch{}let m=typeof c?.announce=="boolean"?c.announce:void 0,h=!!(c?.participants||[]).find(d=>{let g=d?.id||d?.jid||"",y=d?.lid||d?.participant_lid||"",S=g&&g===n,v=!!(a&&(y&&r(y)===r(a)||g&&g.endsWith("@lid")&&r(g)===r(a))),w=o&&(i(g)===o||i(y)===o);return(S||v||w)&&!!d?.admin}),f=m===!0?h:!0;return{id:c.id,name:c.subject||c.id,participants:c.participants?c.participants.length:0,image:p||null,announce:m,isAdmin:h,canSend:f}}))}catch(e){throw e}}async getContacts(e=null){if(!this.sock||!this.isReady)throw new Error("WhatsApp client no est\xE1 listo");try{console.log("[getContacts] Starting contact extraction..."),e&&e.length>0&&console.log(`[getContacts] Filtering by ${e.length} selected groups`);let s=new Map;if(!e||e.length===0){let r=Object.values(this.contactsCache||{});console.log(`[getContacts] Found ${r.length} contacts in cache`),r.forEach(a=>{if(a.id&&a.id.endsWith("@s.whatsapp.net")){let l=a.id.split("@")[0];s.set(l,{id:a.id,phone:l,name:a.name||a.status||l,groups:[]})}});try{let a=await this.sock.store?.chats?.all()||[];console.log(`[getContacts] Found ${a.length} chats in store`),a.forEach(l=>{if(l.id&&l.id.endsWith("@s.whatsapp.net")){let u=l.id.split("@")[0];s.has(u)||s.set(u,{id:l.id,phone:u,name:l.name||l.notify||u,groups:[]})}})}catch(a){console.log("[getContacts] Could not access chats from store:",a.message)}}try{let r=await this.getGroups(),a=e&&e.length>0?r.filter(l=>e.includes(l.id)):r;console.log(`[getContacts] Extracting contacts from ${a.length} groups`);for(let l=0;l<a.length;l++){let u=a[l],c={current:l+1,total:a.length,groupName:u.name,percentage:Math.round((l+1)/a.length*100)};try{this.io?.emit("contacts:extraction:progress",c);let p=await this.getGroupMembersWithRetry(u.id,u.name);console.log(`[getContacts] Group "${u.name}": ${p.length} members`),p.forEach(m=>{let h=m.phone;h&&(s.has(h)?s.get(h).groups.push({id:u.id,name:u.name,image:u.image||null}):s.set(h,{id:m.id,phone:h,name:m.name||h,groups:[{id:u.id,name:u.name,image:u.image||null}]}))})}catch(p){console.log(`[getContacts] Error getting members from group ${u.name}:`,p.message),this.io?.emit("contacts:extraction:error",{groupName:u.name,error:p.message,...c})}}}catch(r){console.log("[getContacts] Error getting groups:",r.message)}let o=Array.from(s.values()).filter(r=>r.phone&&r.phone.length>=8),i=(await Promise.all(o.map(async r=>{let a=null;try{a=await this.sock.profilePictureUrl(r.id,"image")}catch{}return{...r,phone:`+${r.phone.split("@")[0]}`,profilePicUrl:a,groupNames:r.groups.map(l=>l.name).join(", ")||"Sin grupo"}}))).sort((r,a)=>r.phone.localeCompare(a.phone));return console.log(`[getContacts] Returning ${i.length} unique contacts`),i}catch(s){throw console.error("[getContacts] Error:",s),s}}async getGroupMembersWithRetry(e,s,o=3){let n;for(let i=1;i<=o;i++)try{return await this.getGroupMembers(e)}catch(r){n=r;let a=r.message&&r.message.toLowerCase().includes("rate");if(a&&i<o){let l=Math.pow(2,i)*1e3;console.log(`[getGroupMembersWithRetry] Rate limit for "${s}", retrying in ${l}ms (attempt ${i}/${o})`),await new Promise(u=>setTimeout(u,l))}else if(!a)throw r}throw console.error(`[getGroupMembersWithRetry] Failed to get members for "${s}" after ${o} attempts`),n}async getGroupMembers(e){if(!this.sock||!this.isReady)throw new Error("WhatsApp client no est\xE1 listo");try{return((await this.sock.groupMetadata(e)).participants||[]).map(n=>({id:n.id,phone:n?.phoneNumber||n?.phone_number||n?.pn||(n.id||"").split("@")[0],name:n.name||n.notify||(n.id||"").split("@")[0],isAdmin:!!n.admin}))}catch(s){throw s}}getStatus(){let e=null;try{let s=this.sock?.user?.id||this.sock?.user?.jid;s&&(e=s.split("@")[0].split(":")[0].replace(/\D/g,""))}catch{}return{isReady:this.isReady,hasQR:!!this.qrCode,info:this.isReady?{user:this.sock?.user,phone:e}:null,qr:this.qrDataUrl||null}}async destroy(){try{if(this.sock){try{this.sock.ws?.close?.()}catch{}try{this.sock.end?.()}catch{}}}catch{}this.client=null,this.sock=null,this.isReady=!1,this.qrCode=null,this.qrDataUrl=null,this.clearReconnectTimer(),this._reconnectAttempts=0}clearSessionFiles(){try{let e=this.authDir||is();j.existsSync(e)&&(j.rmSync(e,{recursive:!0,force:!0}),console.log(`\u{1F9F9} Sesi\xF3n Baileys eliminada manualmente: ${e}`))}catch(e){console.error("Error al eliminar sesi\xF3n Baileys:",e)}}async resetSession(){await this.destroy(),this.clearSessionFiles(),await this.initialize()}},me=Te;q();import Ue from"node-schedule";import{v4 as Ne}from"uuid";var Oe=class{constructor(e){this.whatsappClient=e,this.jobs=new Map,this.io=e.io}formatTarget(e){return e?e.replace("@s.whatsapp.net","").replace("@c.us",""):"Desconocido"}scheduleMessage(e,s,o,n,i,r=null){let a=Ne();console.log(`Scheduling message to ${e} at ${i} for user ${r}`);let l=Ue.scheduleJob(i,async()=>{try{console.log(`Executing scheduled message to ${e}`),await this.whatsappClient.sendMessage(e,s||"",o,n||""),console.log(`Scheduled message sent to ${e}`);let u=this.formatTarget(e);r?(await N.incrementCount(r,1),console.log(`Incremented message count for user ${r}: +1 message (scheduled)`),await Z.logMessage(r,"single",u,"sent",s||"[Archivo multimedia]",i)):console.warn("Cannot increment message count: userId is missing for scheduled message"),this.io&&this.io.emit("message_log",{id:`scheduled-${a}`,userId:r||null,target:u,status:"sent",timestamp:new Date,content:s||"[Archivo multimedia]",messageType:"single"})}catch(u){console.error(`Failed to send scheduled message to ${e}:`,u);let c=this.formatTarget(e);r&&await Z.logMessage(r,"single",c,"failed",s||"[Archivo multimedia]",i),this.io&&this.io.emit("message_log",{id:`scheduled-${a}-failed`,userId:r||null,target:c,status:"failed",timestamp:new Date,content:s||"[Archivo multimedia]",messageType:"single"})}finally{this.jobs.delete(a)}});return l?(this.jobs.set(a,{type:"single",to:e,scheduledDate:i,job:l,userId:r,message:s,mediaPath:o,caption:n}),a):null}scheduleBulkMessages(e,s,o,n,i,r,a=null,l=null,u=null){let c=Ne();console.log(`Scheduling bulk messages for ${e.length} contacts at ${r} for user ${a}`);let p=Ue.scheduleJob(r,async()=>{try{console.log("Executing scheduled bulk messages");let m=await this.whatsappClient.sendBulkMessages(e,s||"",o,n||"",i,a,l,u);if(a){let h=m.filter(f=>f.status==="sent").length;h>0&&(await N.incrementCount(a,h),console.log(`Incremented message count for user ${a}: +${h} messages (scheduled bulk)`));for(let f of m){let d=this.formatTarget(f.contact);await Z.logMessage(a,"bulk",d,f.status==="sent"?"sent":"failed",s||"[Archivo multimedia]",r)}}else console.warn("Cannot increment message count: userId is missing for scheduled bulk messages");if(this.io){let h=m.filter(f=>f.status==="sent").length;this.io.emit("message_log",{id:`scheduled-bulk-${c}`,userId:a||null,target:`${e.length} contactos`,status:h===e.length||h>0?"sent":"failed",timestamp:new Date,content:`Env\xEDo masivo programado completado (${h}/${e.length} mensajes)`,messageType:"bulk"})}}catch(m){console.error("Failed to execute scheduled bulk messages:",m),this.io&&this.io.emit("message_log",{id:`scheduled-bulk-${c}`,userId:a||null,target:`${e.length} contactos`,status:"failed",timestamp:new Date,content:`Error en env\xEDo masivo programado: ${m.message}`,messageType:"bulk"})}finally{this.jobs.delete(c)}});return p?(this.jobs.set(c,{type:"bulk",count:e.length,scheduledDate:r,job:p,userId:a,contacts:e,message:s,mediaPath:o,caption:n,delay:i,maxContactsPerBatch:l,waitTimeBetweenBatches:u}),c):null}scheduleGroupMessages(e,s,o,n,i,r=null){let a=Ne();console.log(`Scheduling group messages for ${e.length} groups at ${i} for user ${r}`);let l=Ue.scheduleJob(i,async()=>{try{console.log("Executing scheduled group messages");let u={};try{(await this.whatsappClient.getGroups()).forEach(m=>{u[m.id]=m.name})}catch(p){console.warn("Could not fetch group names:",p.message)}let c=0;for(let p of e){try{if(await this.whatsappClient.sendMessage(p,s||"",o,n||""),r){await N.incrementCount(r,1),console.log(`Incremented message count for user ${r}: +1 message (scheduled group)`);let h=u[p]||p;await Z.logMessage(r,"group",h,"sent",s||"[Archivo multimedia]",i)}else console.warn("Cannot increment message count: userId is missing for scheduled group message");c++;let m=u[p]||p;this.io&&this.io.emit("message_log",{id:`scheduled-group-${a}-${p}`,userId:r||null,target:m,status:"sent",timestamp:new Date,content:s||"[Archivo multimedia]",messageType:"group"})}catch(m){console.error(`Failed to send to group ${p}:`,m);let h=u[p]||p;r&&await Z.logMessage(r,"group",h,"failed",s||"[Archivo multimedia]",i),this.io&&this.io.emit("message_log",{id:`scheduled-group-${a}-${p}`,userId:r||null,target:h,status:"failed",timestamp:new Date,content:s||"[Archivo multimedia]",messageType:"group"})}await new Promise(m=>setTimeout(m,1e3))}}catch(u){console.error("Failed to execute scheduled group messages:",u)}finally{this.jobs.delete(a)}});return l?(this.jobs.set(a,{type:"group",count:e.length,scheduledDate:i,job:l,userId:r,groupIds:e,message:s,mediaPath:o,caption:n}),a):null}cancelJob(e,s=null){let o=this.jobs.get(e);return o&&o.job?s&&o.userId&&o.userId!==s?(console.warn(`User ${s} is not authorized to cancel job ${e} owned by ${o.userId}`),!1):(o.job.cancel(),this.jobs.delete(e),!0):!1}rescheduleJob(e,s,o=null){let n=this.jobs.get(e);return!n||!n.job?!1:o&&n.userId&&n.userId!==o?(console.warn(`User ${o} is not authorized to reschedule job ${e} owned by ${n.userId}`),!1):n.job.reschedule(s)?(n.scheduledDate=s,!0):!1}getJobs(){let e=[];return this.jobs.forEach((s,o)=>{e.push({id:o,type:s.type,scheduledDate:s.scheduledDate,details:s.to||`${s.count} recipients`,userId:s.userId||null})}),e}},Le=Oe;import ct from"express";import{v4 as he}from"uuid";import cs from"multer";import We from"path";import ae from"fs";import{fileURLToPath as lt}from"url";var ut=lt(import.meta.url),Mo=We.dirname(ut),V=ct.Router(),ce=t=>{let e=t.app.get("sessionManager");return t.sessionId||e.getFirstActiveSession(t.userId)},fe=(t,e=null)=>t?t.endsWith("@g.us")?e||t:t.replace("@s.whatsapp.net","").replace("@c.us",""):"Desconocido";V.get("/logs",async(t,e)=>{try{let s=t.userId;if(!s)return e.status(401).json({error:"Usuario no autenticado"});let o=t.app.get("messageLogService"),n=parseInt(t.query.limit)||100,r=(await o.getMessageLogs(s,n)).map(a=>({id:a.id.toString(),userId:a.user_id,target:a.recipient,status:a.status,timestamp:new Date(a.sent_at),content:a.content||"",messageType:a.message_type||"single"}));e.json({success:!0,logs:r})}catch(s){console.error("Error getting message logs:",s),e.status(500).json({error:s.message})}});var dt=cs.diskStorage({destination:(t,e,s)=>{let o=process.env.UPLOAD_DIR||"./uploads";ae.existsSync(o)||ae.mkdirSync(o,{recursive:!0}),s(null,o)},filename:(t,e,s)=>{let o=Date.now()+"-"+Math.round(Math.random()*1e9);s(null,o+We.extname(e.originalname))}}),ls=cs({storage:dt,limits:{fileSize:100*1024*1024},fileFilter:(t,e,s)=>{let o=/jpeg|jpg|png|gif|mp4|avi|mov|pdf|doc|docx|xls|xlsx|mp3|wav|ogg/,n=o.test(We.extname(e.originalname).toLowerCase());if(o.test(e.mimetype)&&n)return s(null,!0);s(new Error("Invalid file type"))}});V.post("/send",async(t,e)=>{try{let{to:s,message:o,scheduledAt:n}=t.body,i=t.app.get("sessionManager"),r=t.app.get("messageScheduler"),a=t.app.get("validationService"),l=t.app.get("messageCountService"),u=t.app.get("messageLogService"),c=ce(t);if(!c)return e.status(400).json({error:"No hay una sesi\xF3n de WhatsApp activa"});if(!s)return e.status(400).json({error:"Missing required field: to"});if(!o&&!t.body.mediaPath)return e.status(400).json({error:"Missing required field: message or media"});if(!n){let h=t.userId;if(!h)return e.status(401).json({error:"Usuario no autenticado"});let f=await a.canSendMessages(h,1);if(!f.allowed)return e.status(403).json({error:f.reason,limitExceeded:f.limitExceeded||!1,currentCount:f.currentCount,limit:f.limit})}if(n){let h=new Date(n);if(isNaN(h.getTime()))return e.status(400).json({error:"Invalid date format"});let f=t.userId,d=r.scheduleMessage(s,o||"",null,"",h,f);return e.json({success:!0,message:"Message scheduled",jobId:d})}let p=t.userId;if(!p)return e.status(401).json({error:"Usuario no autenticado"});let m=null;try{let h=fe(s,m),f=await i.sendMessage(c,s,o||"");await l.incrementCount(p,1),await u.logMessage(p,"single",h,"sent",o||"",null);let d=t.app.get("io");d&&d.emit("message_log",{id:he(),userId:p,target:h,status:"sent",timestamp:new Date,content:o||"",messageType:"single"}),e.json({success:!0,result:f})}catch(h){let f=fe(s,m);await u.logMessage(p,"single",f,"failed",o||"",null);let d=t.app.get("io");throw d&&d.emit("message_log",{id:he(),userId:p,target:f,status:"failed",timestamp:new Date,content:o||"",messageType:"single"}),h}}catch(s){console.error("Error sending message:",s),e.status(500).json({error:s.message})}});V.post("/send-media",ls.array("media",10),async(t,e)=>{try{let{to:s,message:o,caption:n,captions:i,scheduledAt:r}=t.body,a=t.app.get("sessionManager"),l=t.app.get("messageScheduler"),u=t.app.get("validationService"),c=t.app.get("messageCountService"),p=t.app.get("messageLogService"),m=ce(t);if(!m)return e.status(400).json({error:"No hay una sesi\xF3n de WhatsApp activa"});if(!s)return e.status(400).json({error:"Missing required field: to"});let h=Array.isArray(t.files)?t.files:[];if(!h||h.length===0)return e.status(400).json({error:"No media file uploaded"});if(!r){let S=t.userId,v=await u.canSendMessages(S,1);if(!v.allowed)return e.status(403).json({error:v.reason})}let f=h.map(S=>S.path),d=[];if(i)try{let S=JSON.parse(i);Array.isArray(S)&&(d=S.map(v=>typeof v=="string"?v:""))}catch{}if(d.length===0&&(d=f.map(()=>n||"")),r){let S=new Date(r),v=t.userId,w=l.scheduleMessage(s,o||"",f,d,S,v);return e.json({success:!0,message:"Media message scheduled",jobId:w})}let g=t.userId,y=null;try{let S=fe(s,y),v=await a.sendMessage(m,s,o||"",f,d);await c.incrementCount(g,1),await p.logMessage(g,"media",S,"sent",o||"[Archivo multimedia]",null);let w=t.app.get("io");w&&w.emit("message_log",{id:he(),userId:g,target:S,status:"sent",timestamp:new Date,content:o||"[Archivo multimedia]",messageType:"media"}),setTimeout(()=>{if(!r)for(let I of f)I&&ae.existsSync(I)&&ae.unlinkSync(I)},5e3),e.json({success:!0,result:v})}catch(S){let v=fe(s,y);await p.logMessage(g,"media",v,"failed",o||"[Archivo multimedia]",null);let w=t.app.get("io");throw w&&w.emit("message_log",{id:he(),userId:g,target:v,status:"failed",timestamp:new Date,content:o||"[Archivo multimedia]",messageType:"media"}),S}}catch(s){console.error("Error sending media:",s),e.status(500).json({error:s.message})}});V.post("/send-bulk",ls.array("media",10),async(t,e)=>{try{let{contacts:s,message:o,caption:n,captions:i,delay:r,scheduledAt:a}=t.body,l=t.app.get("sessionManager"),u=t.app.get("messageScheduler"),c=t.app.get("validationService"),p=t.app.get("messageCountService"),m=t.app.get("messageLogService"),h=ce(t);if(!h)return e.status(400).json({error:"No hay una sesi\xF3n de WhatsApp activa"});if(!s)return e.status(400).json({error:"Missing required field: contacts"});let f=Array.isArray(t.files)?t.files:[],d=typeof s=="string"?JSON.parse(s):s;if(!a){let _=t.userId,b=await c.canSendMessages(_,d.length);if(!b.allowed)return e.status(403).json({error:b.reason})}let g=f.map(_=>_.path),y=[];if(i)try{let _=JSON.parse(i);Array.isArray(_)&&(y=_.map(b=>typeof b=="string"?b:""))}catch{}y.length===0&&(y=g.map(()=>n||""));let S=t.userId,v=parseInt(r)||2,w=50,I=15;if(a){let _=new Date(a),b=u.scheduleBulkMessages(d,o||"",g,y,v,_,S,w,I);return e.json({success:!0,message:"Bulk messages scheduled",jobId:b})}l.sendBulkMessages(h,d,o||"",g,y,v,S,w,I).then(async _=>{let b=_.filter(D=>D.status==="sent").length;b>0&&await p.incrementCount(S,b);let M=t.app.get("io");for(let D of _){let k=D.status==="sent"?"sent":"failed",G=fe(D.contact);await m.logMessage(S,"bulk",G,k,o||"[Archivo multimedia]",null),M&&M.emit("message_log",{id:he(),userId:S,target:G,status:k,timestamp:new Date,content:o||"[Archivo multimedia]",messageType:"bulk"})}if(g.length>0)for(let D of g)D&&ae.existsSync(D)&&ae.unlinkSync(D)}).catch(_=>console.error("Error in bulk send:",_)),e.json({success:!0,message:"Bulk send started",total:d.length})}catch(s){console.error("Error starting bulk send:",s),e.status(500).json({error:s.message})}});V.post("/bulk/pause",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=ce(t),n=s.getSessionClient(o);n&&n.pauseBulk(t.userId),e.json({success:!0})}catch(s){e.status(500).json({error:s.message})}});V.post("/bulk/resume",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=ce(t),n=s.getSessionClient(o);n&&n.resumeBulk(t.userId),e.json({success:!0})}catch(s){e.status(500).json({error:s.message})}});V.post("/bulk/cancel",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=ce(t),n=s.getSessionClient(o);n&&n.cancelBulk(t.userId),e.json({success:!0})}catch(s){e.status(500).json({error:s.message})}});V.get("/scheduled",async(t,e)=>{try{let s=t.userId,n=t.app.get("messageScheduler").getJobs().filter(i=>!i.userId||i.userId===s);e.json({success:!0,jobs:n})}catch(s){e.status(500).json({error:s.message})}});V.delete("/scheduled/:jobId",async(t,e)=>{try{let s=t.userId,{jobId:o}=t.params;if(!t.app.get("messageScheduler").cancelJob(o,s))return e.status(404).json({error:"Job no encontrado"});e.json({success:!0})}catch(s){e.status(500).json({error:s.message})}});V.put("/scheduled/:jobId",async(t,e)=>{try{let s=t.userId,{jobId:o}=t.params,{scheduledAt:n}=t.body,i=new Date(n);if(!t.app.get("messageScheduler").rescheduleJob(o,i,s))return e.status(404).json({error:"Job no encontrado"});e.json({success:!0,scheduledAt:i.toISOString()})}catch(s){e.status(500).json({error:s.message})}});var us=V;import pt from"express";import{v4 as ds}from"uuid";import gs from"multer";import X from"fs";import le from"path";import{fileURLToPath as gt}from"url";var mt=gt(import.meta.url),ht=le.dirname(mt),z=pt.Router(),Fe=t=>{let e=t.app.get("sessionManager");return t.sessionId||e.getFirstActiveSession(t.userId)},ps=(t,e=null)=>t?t.endsWith("@g.us")?e||t:t.replace("@s.whatsapp.net","").replace("@c.us",""):"Desconocido",ft=gs.diskStorage({destination:(t,e,s)=>{let o=process.env.UPLOAD_DIR||"./uploads";X.existsSync(o)||X.mkdirSync(o,{recursive:!0}),s(null,o)},filename:(t,e,s)=>{let o=Date.now()+"-"+Math.round(Math.random()*1e9);s(null,o+le.extname(e.originalname))}}),ms=gs({storage:ft,limits:{fileSize:100*1024*1024},fileFilter:(t,e,s)=>{let o=/jpeg|jpg|png|gif|mp4|avi|mov|pdf|doc|docx|xls|xlsx|mp3|wav|ogg/;if(o.test(le.extname(e.originalname).toLowerCase())&&o.test(e.mimetype))return s(null,!0);s(new Error("Invalid file type"))}});z.get("/",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=Fe(t);if(!o)return e.json({success:!1,groups:[],error:"WhatsApp no conectado"});try{let n=await s.getGroups(o);return e.json({success:!0,groups:n})}catch(n){return e.json({success:!1,groups:[],error:n.message})}}catch(s){e.status(500).json({error:s.message})}});z.get("/:id/members",async(t,e)=>{try{let{id:s}=t.params,o=t.app.get("sessionManager"),n=Fe(t);if(!n)return e.status(400).json({error:"WhatsApp no conectado"});let r=await o.getSessionClient(n).getGroupMembers(s);e.json({success:!0,members:r})}catch(s){e.status(500).json({error:s.message})}});z.post("/send",ms.array("media",10),async(t,e)=>{try{let s=t.body.groupIds;typeof s=="string"&&(s=JSON.parse(s));let{message:o,caption:n,captions:i,scheduledAt:r}=t.body,a=t.app.get("sessionManager"),l=t.app.get("messageScheduler"),u=t.app.get("validationService"),c=t.app.get("messageCountService"),p=t.app.get("messageLogService"),m=Fe(t);if(!m)return e.status(400).json({error:"WhatsApp no conectado"});let f=(Array.isArray(t.files)?t.files:[]).map(v=>v.path),d=Array.isArray(i)?i:i?JSON.parse(i):[];if(d.length===0&&(d=f.map(()=>n||"")),r){let v=t.userId,w=l.scheduleGroupMessages(s,o||"",f,d,new Date(r),v);return e.json({success:!0,message:"Group messages scheduled",jobId:w})}let g=t.userId,y=s.length,S=t.app.get("io");(async()=>{let v=0,w=0,I={},_=a.getSessionClient(m);if(_&&_.sock)try{I=await _.sock.groupFetchAllParticipating()}catch{}for(let b=0;b<s.length;b++){let M=s[b];try{let D=I[M],k=ps(M,D?.subject);await a.sendMessage(m,M,o||"",f,d),v++,S&&(S.emit("group_progress",{userId:g,current:b+1,total:y,successCount:v,failedCount:w,groupId:M,status:"sent"}),S.emit("message_log",{id:ds(),userId:g,target:k,status:"sent",timestamp:new Date,content:o||"[Archivo multimedia]",messageType:"group"})),await c.incrementCount(g,1),await p.logMessage(g,"group",k,"sent",o||"[Archivo multimedia]",null),b<s.length-1&&await new Promise(G=>setTimeout(G,1e3))}catch(D){console.error(`[Groups] Error sending to group ${M}:`,D);let k=ps(M,I[M]?.subject);w++,S&&(S.emit("group_progress",{userId:g,current:b+1,total:y,successCount:v,failedCount:w,groupId:M,status:"failed",error:D.message}),S.emit("message_log",{id:ds(),userId:g,target:k,status:"failed",timestamp:new Date,content:o||"[Archivo multimedia]",messageType:"group"})),await p.logMessage(g,"group",k,"failed",o||"[Archivo multimedia]",null),b<s.length-1&&await new Promise(G=>setTimeout(G,1e3))}}f.length>0&&setTimeout(()=>{for(let b of f)X.existsSync(b)&&X.unlinkSync(b)},5e3)})(),e.json({success:!0,message:"Enviando a grupos..."})}catch(s){e.status(500).json({error:s.message})}});var hs=()=>le.join(ht,"../data/groupLists.json"),Be=()=>{try{let t=hs();if(X.existsSync(t))return JSON.parse(X.readFileSync(t,"utf8"))}catch{}return[]},fs=t=>{try{let e=hs();X.existsSync(le.dirname(e))||X.mkdirSync(le.dirname(e),{recursive:!0}),X.writeFileSync(e,JSON.stringify(t,null,2))}catch{}};z.get("/lists",(t,e)=>e.json({success:!0,lists:Be()}));z.post("/lists",(t,e)=>{let{name:s,groupIds:o}=t.body,n=Be(),i={id:Date.now().toString(),name:s,groupIds:o,createdAt:new Date};n.push(i),fs(n),e.json({success:!0,list:i})});z.delete("/lists/:id",(t,e)=>{let s=Be();s=s.filter(o=>o.id!==t.params.id),fs(s),e.json({success:!0})});z.post("/schedule",ms.array("media",10),async(t,e)=>{try{let s=t.body.groupIds;typeof s=="string"&&(s=JSON.parse(s));let{message:o,caption:n,captions:i,scheduleType:r,delayMinutes:a,scheduledAt:l}=t.body,u=t.app.get("messageScheduler"),p=(Array.isArray(t.files)?t.files:[]).map(d=>d.path),m=Array.isArray(i)?i:i?JSON.parse(i):[];m.length===0&&(m=p.map(()=>n||""));let h;r==="delay"?h=new Date(Date.now()+(a||0)*60*1e3):h=new Date(l);let f=u.scheduleGroupMessages(s,o||"",p,m,h,t.userId);e.json({success:!0,jobId:f,scheduledAt:h.toISOString()})}catch(s){e.status(500).json({error:s.message})}});z.get("/selections",async(t,e)=>{let o=await t.app.get("groupSelectionService").getByUserId(t.userId);e.json({success:!0,selections:o})});z.post("/selections",async(t,e)=>{let{name:s,description:o,groupIds:n}=t.body,r=await t.app.get("groupSelectionService").create(t.userId,s,o,n);e.json({success:!0,selection:r})});z.put("/selections/:id",async(t,e)=>{let o=await t.app.get("groupSelectionService").update(t.params.id,t.userId,t.body);e.json({success:!0,selection:o})});z.delete("/selections/:id",async(t,e)=>{await t.app.get("groupSelectionService").delete(t.params.id,t.userId),e.json({success:!0})});var ys=z;import yt from"express";var Ss=yt.Router();Ss.get("/",async(t,e)=>{try{let s=t.app.get("whatsappClient"),o=t.query.groupIds,n=o?o.split(","):null,i=await s.getContacts(n);e.json({success:!0,contacts:i})}catch(s){console.error("Error getting contacts:",s),e.status(500).json({error:s.message})}});var ws=Ss;import vt from"express";import Is from"multer";import $ from"path";import W from"fs";import{fileURLToPath as bt}from"url";import ue from"fs";import Q from"path";import{fileURLToPath as St}from"url";var wt=St(import.meta.url),Wo=Q.dirname(wt);function vs(t=[],e=[]){let s=new Set;return t.forEach(o=>{if(o.mediaPaths&&Array.isArray(o.mediaPaths)&&o.mediaPaths.forEach(n=>{if(n&&!n.startsWith("http")){let i=Q.basename(n);s.add(i)}}),o.mediaPath&&!o.mediaPath.startsWith("http")){let n=Q.basename(o.mediaPath);s.add(n)}o.options&&Array.isArray(o.options)&&o.options.forEach(n=>{if(n.mediaPaths&&Array.isArray(n.mediaPaths)&&n.mediaPaths.forEach(i=>{if(i&&!i.startsWith("http")){let r=Q.basename(i);s.add(r)}}),n.mediaPath&&!n.mediaPath.startsWith("http")){let i=Q.basename(n.mediaPath);s.add(i)}})}),e.forEach(o=>{if(o.mediaPaths&&Array.isArray(o.mediaPaths)&&o.mediaPaths.forEach(n=>{if(n&&!n.startsWith("http")){let i=Q.basename(n);s.add(i)}}),o.mediaPath&&!o.mediaPath.startsWith("http")){let n=Q.basename(o.mediaPath);s.add(n)}}),s}function bs(t,e){let s={deleted:[],errors:[],totalFiles:0,deletedCount:0};try{if(!ue.existsSync(t))return s;let o=ue.readdirSync(t);s.totalFiles=o.length,o.forEach(n=>{let i=Q.join(t,n);try{if(!ue.statSync(i).isFile())return}catch(r){s.errors.push({fileName:n,error:r.message});return}if(!e.has(n))try{ue.unlinkSync(i),s.deleted.push(n),s.deletedCount++,console.log(`[MediaCleanup] Deleted orphaned file: ${n}`)}catch(r){s.errors.push({fileName:n,error:r.message}),console.error(`[MediaCleanup] Error deleting ${n}:`,r)}})}catch(o){console.error("[MediaCleanup] Error reading upload directory:",o),s.errors.push({error:o.message})}return s}function ye(t){let e={deleted:[],errors:[]},s=[];return t.mediaPaths&&Array.isArray(t.mediaPaths)&&s.push(...t.mediaPaths),t.mediaPath&&s.push(t.mediaPath),s.forEach(o=>{if(o&&!o.startsWith("http"))try{ue.existsSync(o)&&(ue.unlinkSync(o),e.deleted.push(Q.basename(o)),console.log(`[MediaCleanup] Deleted file: ${Q.basename(o)}`))}catch(n){e.errors.push({file:Q.basename(o),error:n.message}),console.error(`[MediaCleanup] Error deleting ${o}:`,n)}}),e}function ee(t,e="./uploads"){let s=t.interactiveMenus||[],o=t.autoReplyRules||[],n=vs(s,o),i=bs(e,n);return console.log(`[MediaCleanup] Session cleanup complete: ${i.deletedCount} orphaned files deleted`),i}function As(t,e="./uploads"){let s=new Set;if(t&&t.sessions)for(let[n,i]of t.sessions.entries()){let r=i.client;if(r){let a=r.interactiveMenus||[],l=r.autoReplyRules||[];vs(a,l).forEach(c=>s.add(c))}}let o=bs(e,s);return console.log(`[MediaCleanup] Global cleanup complete: ${o.deletedCount} orphaned files deleted from ${t?.sessions?.size||0} sessions`),o}var At=bt(import.meta.url),_s=$.dirname(At),ne=vt.Router(),de=t=>{let e=t.app.get("sessionManager");return t.sessionId?t.sessionId:t.userId?e.getFirstActiveSession(t.userId):e.sessions&&e.sessions.size>0?e.sessions.keys().next().value:null},It=Is.diskStorage({destination:(t,e,s)=>{let o=process.env.UPLOAD_DIR||"./uploads";W.existsSync(o)||W.mkdirSync(o,{recursive:!0}),s(null,o)},filename:(t,e,s)=>{let o=Date.now()+"-"+Math.round(Math.random()*1e9);s(null,o+$.extname(e.originalname))}}),ze=Is({storage:It,limits:{fileSize:100*1024*1024},fileFilter:(t,e,s)=>{let o=/jpeg|jpg|png|gif|mp4|avi|mov|pdf|doc|docx|xls|xlsx|mp3|wav|ogg|webp|zip|json/;if(o.test($.extname(e.originalname).toLowerCase())&&o.test(e.mimetype))return s(null,!0);s(new Error("Invalid file type"))}});ne.get("/rules",(t,e)=>{try{let s=t.app.get("sessionManager"),o=de(t);if(!o)return e.json({success:!0,rules:[]});let n=s.getSessionClient(o);if(!n)return e.json({success:!0,rules:[]});let i=n.autoReplyRules.map(r=>{let a={...r};if(a.keywords&&typeof a.keywords=="string")try{a.keywords=JSON.parse(a.keywords)}catch{a.keywords=a.keywords.split(",").map(l=>l.trim()).filter(l=>l.length>0)}return Array.isArray(a.keywords)||(a.keywords=[]),a.isActive!==void 0?a.isActive=!!a.isActive:a.isActive=!0,a});e.json({success:!0,rules:i})}catch(s){console.error("Error getting rules:",s),e.status(500).json({error:s.message})}});ne.post("/rules",ze.array("media",10),(t,e)=>{try{let s=t.app.get("sessionManager"),o=de(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let i=t.body;if(!i.name||!i.keywords)return e.status(400).json({error:"Missing required fields: name, keywords"});let r=Array.isArray(t.files)?t.files:[];if(i.type==="menu"&&!i.menuId)return e.status(400).json({error:"Menu-type rules require menuId"});if(i.type!=="menu"&&!i.response&&(!r||r.length===0))return e.status(400).json({error:"Missing required field: response or media"});let a=[];if(typeof i.keywords=="string")try{a=JSON.parse(i.keywords)}catch{a=i.keywords.split(",").map(p=>p.trim()).filter(p=>p.length>0)}else Array.isArray(i.keywords)&&(a=i.keywords);i.id=Date.now().toString(),i.keywords=a;let l=r.map(p=>$.relative(process.cwd(),p.path).replace(/\\/g,"/")),u=[];if(i.captions)try{let p=JSON.parse(i.captions);Array.isArray(p)&&(u=p.map(m=>typeof m=="string"?m:""))}catch{}u.length===0&&l.length>0&&(u=l.map(()=>i.caption||"")),i.mediaPaths=l,i.captions=u,i.mediaPath=l[0]||null,i.caption=u[0]||i.caption||"",i.isActive!==void 0?i.isActive=String(i.isActive)==="true"||i.isActive===!0||i.isActive==="1":i.isActive=!0,i.type=i.type||"simple",n.autoReplyRules.push(i),n.saveAutoReplyRules();let c={...i,isActive:!!i.isActive};e.json({success:!0,rule:c})}catch(s){console.error("Error creating rule:",s),e.status(500).json({error:s.message})}});ne.put("/rules/:id",ze.array("media",10),(t,e)=>{try{let s=t.app.get("sessionManager"),o=de(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let{id:i}=t.params,r=t.body,a=n.autoReplyRules.findIndex(d=>d.id===i);if(a===-1)return e.status(404).json({error:"Rule not found"});if(r.keywords){let d=[];if(typeof r.keywords=="string")try{d=JSON.parse(r.keywords)}catch{d=r.keywords.split(",").map(g=>g.trim()).filter(g=>g.length>0)}else Array.isArray(r.keywords)&&(d=r.keywords);r.keywords=d}r.isActive!==void 0&&(r.isActive=String(r.isActive)==="true"||r.isActive===!0||r.isActive==="1");let l=Array.isArray(t.files)?t.files:[],u=[],c=[];if(r.existingMediaPaths){try{let d=typeof r.existingMediaPaths=="string"?JSON.parse(r.existingMediaPaths):r.existingMediaPaths;Array.isArray(d)&&(u=d)}catch(d){console.error("Error parsing existingMediaPaths:",d)}delete r.existingMediaPaths}if(r.captions)try{let d=typeof r.captions=="string"?JSON.parse(r.captions):r.captions;Array.isArray(d)&&(c=d.map(g=>typeof g=="string"?g:""))}catch(d){console.error("Error parsing captions:",d)}if(l&&l.length>0){let d=l.map(y=>$.relative(process.cwd(),y.path).replace(/\\/g,"/"));u=[...u,...d];let g=l.map(()=>r.caption||"");c=[...c,...g]}r.mediaPaths=u,r.captions=c,r.mediaPath=u[0]||null,r.caption=c[0]||"",r.existingMediaPath&&delete r.existingMediaPath;let p=n.autoReplyRules[a],m={...p,...r,keywords:r.keywords||p.keywords,id:p.id,mediaPath:r.mediaPath!==void 0?r.mediaPath:p.mediaPath,mediaPaths:r.mediaPaths!==void 0?r.mediaPaths:p.mediaPaths,captions:r.captions!==void 0?r.captions:p.captions,type:r.type!==void 0?r.type:p.type||"simple",menuId:r.menuId!==void 0?r.menuId:p.menuId};n.autoReplyRules[a]=m,n.saveAutoReplyRules();let h=process.env.UPLOAD_DIR||$.join(_s,"..","uploads");ee(n,h);let f={...m};if(f.keywords&&typeof f.keywords=="string")try{f.keywords=JSON.parse(f.keywords)}catch{f.keywords=[]}f.isActive=!!f.isActive,e.json({success:!0,rule:f})}catch(s){console.error("Error updating rule:",s),e.status(500).json({error:s.message})}});ne.delete("/rules/:id",(t,e)=>{try{let s=t.app.get("sessionManager"),o=de(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let{id:i}=t.params,r=n.autoReplyRules.findIndex(u=>u.id===i);if(r===-1)return e.status(404).json({error:"Rule not found"});let a=n.autoReplyRules[r];ye(a),n.autoReplyRules.splice(r,1),n.saveAutoReplyRules();let l=process.env.UPLOAD_DIR||$.join(_s,"..","uploads");ee(n,l),e.json({success:!0,message:"Rule deleted"})}catch(s){e.status(500).json({error:s.message})}});ne.get("/export",async(t,e)=>{console.log("[Export Rules] ========== EXPORT RULES ENDPOINT CALLED ==========");try{console.log("[Export Rules] Step 1: Getting session manager");let s=t.app.get("sessionManager"),o=de(t);console.log("[Export Rules] Step 2: Session ID:",o);let n=o?s.getSessionClient(o):null;console.log("[Export Rules] Step 3: Client:",n?"Found":"Not found");let i=n?n.autoReplyRules:[];if(console.log("[Export Rules] Step 4: Rules count:",i.length),i.length===0)return console.log("[Export Rules] No rules to export, returning empty JSON"),e.json({success:!0,rules:[],exportDate:new Date().toISOString(),count:0});console.log(`[Export Rules] Exporting ${i.length} rules`),i.forEach((c,p)=>{console.log(`[Export Rules] Rule ${p}: ${c.name}, mediaPaths:`,c.mediaPaths,"mediaPath:",c.mediaPath)}),console.log("[Export Rules] Step 5: Collecting media files");let r=new Set;i.forEach(c=>{c.mediaPaths&&Array.isArray(c.mediaPaths)?c.mediaPaths.forEach(p=>{p&&!p.startsWith("http")&&r.add(p)}):c.mediaPath&&!c.mediaPath.startsWith("http")&&r.add(c.mediaPath)}),console.log(`[Export Rules] Found ${r.size} media files:`,Array.from(r)),console.log("[Export Rules] Step 6: Creating ZIP archive");let a=(await import("archiver")).default,l=a("zip",{zlib:{level:9}});console.log("[Export Rules] Step 7: Setting response headers"),e.attachment("auto-reply-rules-export.zip"),l.pipe(e),console.log("[Export Rules] Step 8: Adding JSON file to ZIP");let u={rules:i,exportDate:new Date().toISOString(),count:i.length,version:"1.0"};l.append(JSON.stringify(u,null,2),{name:"rules.json"}),console.log("[Export Rules] Step 9: Adding media files to ZIP");for(let c of r){let p=$.isAbsolute(c)?c:$.join(process.cwd(),c);if(W.existsSync(p)){let m=$.basename(c);console.log(`[Export Rules] Adding media file: ${m} from ${p}`),l.file(p,{name:`media/${m}`})}else console.warn(`[Export Rules] Media file not found: ${p}`)}console.log("[Export Rules] Step 10: Finalizing ZIP archive"),l.finalize(),console.log("[Export Rules] ========== EXPORT COMPLETED SUCCESSFULLY ==========")}catch(s){console.error("[Export Rules] ERROR:",s),console.error("[Export Rules] Error stack:",s.stack),e.status(500).json({error:s.message})}});ne.post("/rules/import",ze.single("file"),async(t,e)=>{try{let s=t.app.get("sessionManager"),o=de(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let i;if(t.file){let c=t.file.path,p=$.extname(t.file.originalname).toLowerCase();if(p===".zip"){let m=(await import("unzipper")).default,h=process.env.UPLOAD_DIR||"./uploads";W.existsSync(h)||W.mkdirSync(h,{recursive:!0});let f=await m.Open.file(c),d=null;for(let g of f.files)if(g.path==="rules.json"){let y=await g.buffer();d=JSON.parse(y.toString("utf8"))}else if(g.path.startsWith("media/")){let y=$.basename(g.path),S=$.join(h,y);W.existsSync(S)&&W.unlinkSync(S);let v=await g.buffer();W.writeFileSync(S,v)}if(!d)return W.unlinkSync(c),e.status(400).json({error:"Invalid ZIP file: rules.json not found"});i=d.rules||[],W.unlinkSync(c)}else if(p===".json"){let m=W.readFileSync(c,"utf8"),h=JSON.parse(m);i=Array.isArray(h)?h:h.rules||[],W.unlinkSync(c)}else return W.unlinkSync(c),e.status(400).json({error:"Invalid file type. Please upload a .zip or .json file"})}else if(t.body.rules)i=t.body.rules;else return e.status(400).json({error:"No file or data provided"});if(!Array.isArray(i))return e.status(400).json({error:"Rules must be an array"});let r=process.env.UPLOAD_DIR||"./uploads",a={success:0,failed:0,replaced:0,errors:[],rules:[]},u=t.body.applyToAllSessions==="true"?Array.from(s.sessions.values()).map(c=>c.client):[n];console.log(`[Import] Applying to ${u.length} session(s)`);for(let c of i)try{if(!c.name||!c.keywords){a.failed++,a.errors.push(`Rule "${c.name||"unnamed"}": Missing required fields`);continue}let p=Array.isArray(c.keywords)?c.keywords:typeof c.keywords=="string"?c.keywords.split(",").map(f=>f.trim()):[],m=[];if(c.mediaPaths&&Array.isArray(c.mediaPaths))m=c.mediaPaths.map(f=>{if(f&&!f.startsWith("http")){let d=$.basename(f);return $.join(r,d)}return f});else if(c.mediaPath&&!c.mediaPath.startsWith("http")){let f=$.basename(c.mediaPath);m=[$.join(r,f)]}let h=c.menuId;if(c.type==="menu"&&c.menuId){let f=u[0],d=f.interactiveMenus.find(y=>y.name==="Principal"||y.isActive),g=f.interactiveMenus.find(y=>String(y.id)===String(c.menuId));!g&&d?(console.log(`[Import] Updating menuId for rule "${c.name}" from ${c.menuId} to ${d.id}`),h=d.id):g&&(h=g.id)}u.forEach((f,d)=>{let g=f.autoReplyRules.findIndex(y=>y.name===c.name);if(g!==-1){let S={id:f.autoReplyRules[g].id,name:c.name,keywords:p,response:c.response||"",matchType:c.matchType||"contains",delay:c.delay||2,isActive:c.isActive!==void 0?c.isActive:!0,mediaPaths:m,mediaPath:m[0]||null,captions:c.captions||[],caption:c.captions&&c.captions[0]||c.caption||"",type:c.type||"simple",menuId:h||null};f.autoReplyRules[g]=S,d===0&&(a.replaced++,a.rules.push(S),console.log(`[Import] Replaced existing rule: ${c.name}`))}else{let y={id:Date.now().toString()+"-"+Math.round(Math.random()*1e9),name:c.name,keywords:p,response:c.response||"",matchType:c.matchType||"contains",delay:c.delay||2,isActive:c.isActive!==void 0?c.isActive:!0,mediaPaths:m,mediaPath:m[0]||null,captions:c.captions||[],caption:c.captions&&c.captions[0]||c.caption||"",type:c.type||"simple",menuId:h||null};f.autoReplyRules.push(y),d===0&&(a.success++,a.rules.push(y),console.log(`[Import] Created new rule: ${c.name}`))}})}catch(p){a.failed++,a.errors.push(`Rule "${c.name||"unnamed"}": ${p.message}`)}u.forEach(c=>{c.saveAutoReplyRules()}),e.json({success:a.success>0,...a})}catch(s){console.error("Error importing rules:",s),e.status(500).json({error:s.message})}});var js=ne;import _t from"express";import Ms from"multer";import T from"path";import F from"fs";import{fileURLToPath as jt}from"url";var Mt=jt(import.meta.url),Je=T.dirname(Mt),K=_t.Router(),se=t=>{let e=t.app.get("sessionManager");return t.sessionId?t.sessionId:t.userId?e.getFirstActiveSession(t.userId):e.sessions&&e.sessions.size>0?e.sessions.keys().next().value:null},Et=Ms.diskStorage({destination:(t,e,s)=>{let o=process.env.UPLOAD_DIR||T.join(Je,"..","uploads");F.existsSync(o)||F.mkdirSync(o,{recursive:!0}),s(null,o)},filename:(t,e,s)=>{let o=Date.now()+"-"+Math.round(Math.random()*1e9);s(null,o+T.extname(e.originalname))}}),be=Ms({storage:Et});K.get("/",(t,e)=>{try{let s=t.app.get("sessionManager"),o=se(t);if(!o)return e.json({success:!0,menus:[]});let n=s.getSessionClient(o);if(!n)return e.json({success:!0,menus:[]});e.json({success:!0,menus:n.interactiveMenus})}catch(s){console.error("Error getting menus:",s),e.status(500).json({error:s.message})}});K.post("/",be.array("media",50),(t,e)=>{try{let s=t.app.get("sessionManager"),o=se(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let i=t.files||[],r={name:t.body.name,message:t.body.message,isActive:t.body.isActive==="true"||t.body.isActive===!0,options:[]};if(t.body.options)try{r.options=typeof t.body.options=="string"?JSON.parse(t.body.options):t.body.options}catch{r.options=[]}if(t.body.menuMediaPaths)try{r.mediaPaths=typeof t.body.menuMediaPaths=="string"?JSON.parse(t.body.menuMediaPaths):t.body.menuMediaPaths}catch{r.mediaPaths=[]}if(t.body.menuCaptions)try{r.captions=typeof t.body.menuCaptions=="string"?JSON.parse(t.body.menuCaptions):t.body.menuCaptions}catch{r.captions=[]}if(!r.name)return e.status(400).json({error:"Missing required field: name"});let a=r.captions&&r.captions.some(l=>l&&l.trim().length>0);if(!r.message&&!a)return e.status(400).json({error:"Missing required field: message (or provide captions in media)"});if(r.id=Date.now().toString(),r.createdAt=new Date().toISOString(),r.updatedAt=new Date().toISOString(),i.length>0){let l=i.map(u=>T.relative(process.cwd(),u.path).replace(/\\/g,"/"));r.mediaPaths=r.mediaPaths||[],r.mediaPaths.push(...l)}n.interactiveMenus.push(r),n.saveInteractiveMenus(),e.json({success:!0,menu:r})}catch(s){console.error("Error creating menu:",s),e.status(500).json({error:s.message})}});K.put("/:id",be.array("media",50),(t,e)=>{try{let s=t.app.get("sessionManager"),o=se(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let{id:i}=t.params,r=t.files||[],a=n.interactiveMenus.findIndex(m=>m.id===i);if(a===-1)return e.status(404).json({error:"Menu not found"});let l=n.interactiveMenus[a],u={name:t.body.name!==void 0?t.body.name:l.name,message:t.body.message!==void 0?t.body.message:l.message,isActive:t.body.isActive!==void 0?t.body.isActive==="true"||t.body.isActive===!0:l.isActive};if(t.body.options)try{u.options=typeof t.body.options=="string"?JSON.parse(t.body.options):t.body.options}catch{u.options=l.options||[]}else u.options=l.options||[];if(t.body.menuMediaPaths)try{u.mediaPaths=typeof t.body.menuMediaPaths=="string"?JSON.parse(t.body.menuMediaPaths):t.body.menuMediaPaths}catch{u.mediaPaths=[]}else u.mediaPaths=[];if(t.body.menuCaptions)try{u.captions=typeof t.body.menuCaptions=="string"?JSON.parse(t.body.menuCaptions):t.body.menuCaptions}catch{u.captions=[]}else u.captions=[];if(r.length>0){let m=r.map(h=>T.relative(process.cwd(),h.path).replace(/\\/g,"/"));u.mediaPaths=[...u.mediaPaths,...m]}let c={...l,...u,id:l.id,createdAt:l.createdAt,updatedAt:new Date().toISOString()};n.interactiveMenus[a]=c,n.saveInteractiveMenus();let p=process.env.UPLOAD_DIR||T.join(Je,"..","uploads");ee(n,p),e.json({success:!0,menu:c})}catch(s){console.error("Error updating menu:",s),e.status(500).json({error:s.message})}});K.post("/upload-option-media",be.array("media",10),(t,e)=>{try{let s=t.files||[];if(s.length===0)return e.status(400).json({error:"No files uploaded"});let o=s.map(n=>({path:n.path,filename:n.filename,originalname:n.originalname,mimetype:n.mimetype,size:n.size}));e.json({success:!0,files:o})}catch(s){e.status(500).json({error:s.message})}});K.delete("/:id",(t,e)=>{try{let s=t.app.get("sessionManager"),o=se(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let{id:i}=t.params,r=n.interactiveMenus.findIndex(u=>u.id===i);if(r===-1)return e.status(404).json({error:"Menu not found"});let a=n.interactiveMenus[r];ye(a),a.options&&Array.isArray(a.options)&&a.options.forEach(u=>{ye(u)}),n.interactiveMenus.splice(r,1),n.saveInteractiveMenus();let l=process.env.UPLOAD_DIR||T.join(Je,"..","uploads");ee(n,l),e.json({success:!0,message:"Menu deleted successfully"})}catch(s){e.status(500).json({error:s.message})}});K.get("/sessions",(t,e)=>{try{let s=t.app.get("sessionManager"),o=se(t);if(!o)return e.json({success:!0,sessions:[]});let n=s.getSessionClient(o);if(!n)return e.json({success:!0,sessions:[]});let i=Array.from(n.userSessions.values());e.json({success:!0,sessions:i})}catch(s){e.status(500).json({error:s.message})}});K.delete("/sessions/:userId",(t,e)=>{try{let s=t.app.get("sessionManager"),o=se(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let{userId:i}=t.params;n.clearSession(i),e.json({success:!0,message:"Session cleared successfully"})}catch(s){e.status(500).json({error:s.message})}});K.get("/export",async(t,e)=>{console.log("[Export] ========== EXPORT ENDPOINT CALLED ==========");try{console.log("[Export] Step 1: Getting session manager");let s=t.app.get("sessionManager"),o=se(t);console.log("[Export] Step 2: Session ID:",o);let n=o?s.getSessionClient(o):null;console.log("[Export] Step 3: Client:",n?"Found":"Not found");let i=n?n.interactiveMenus:[];if(console.log("[Export] Step 4: Menus count:",i.length),i.length===0)return console.log("[Export] No menus to export, returning empty JSON"),e.json({success:!0,menus:[],exportDate:new Date().toISOString(),count:0});console.log(`[Export] Exporting ${i.length} menus`),i.forEach((c,p)=>{console.log(`[Export] Menu ${p}: ${c.name}, mediaPaths:`,c.mediaPaths),c.options&&c.options.forEach((m,h)=>{m.mediaPaths&&m.mediaPaths.length>0&&console.log(`[Export]   Option ${h}: ${m.label}, mediaPaths:`,m.mediaPaths)})}),console.log("[Export] Step 5: Collecting media files");let r=new Set;i.forEach(c=>{c.mediaPaths&&Array.isArray(c.mediaPaths)&&c.mediaPaths.forEach(p=>{p&&!p.startsWith("http")&&r.add(p)}),c.options&&Array.isArray(c.options)&&c.options.forEach(p=>{p.mediaPaths&&Array.isArray(p.mediaPaths)&&p.mediaPaths.forEach(m=>{m&&!m.startsWith("http")&&r.add(m)})})}),console.log(`[Export] Found ${r.size} media files:`,Array.from(r)),console.log("[Export] Step 6: Creating ZIP archive");let a=(await import("archiver")).default,l=a("zip",{zlib:{level:9}});console.log("[Export] Step 7: Setting response headers"),e.attachment("menus-export.zip"),l.pipe(e),console.log("[Export] Step 8: Adding JSON file to ZIP");let u={menus:i,exportDate:new Date().toISOString(),count:i.length,version:"1.0"};l.append(JSON.stringify(u,null,2),{name:"menus.json"}),console.log("[Export] Step 9: Adding media files to ZIP");for(let c of r){let p=T.isAbsolute(c)?c:T.join(process.cwd(),c);if(F.existsSync(p)){let m=T.basename(c);console.log(`[Export] Adding media file: ${m} from ${p}`),l.file(p,{name:`media/${m}`})}else console.warn(`[Export] Media file not found: ${p}`)}console.log("[Export] Step 10: Finalizing ZIP archive"),l.finalize(),console.log("[Export] ========== EXPORT COMPLETED SUCCESSFULLY ==========")}catch(s){console.error("[Export] ERROR:",s),console.error("[Export] Error stack:",s.stack),e.status(500).json({error:s.message})}});K.post("/import",be.single("file"),async(t,e)=>{try{let s=t.app.get("sessionManager"),o=se(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let i;if(t.file){let h=t.file.path,f=T.extname(t.file.originalname).toLowerCase();if(f===".zip"){let d=(await import("unzipper")).default,g=process.env.UPLOAD_DIR||"./uploads";F.existsSync(g)||F.mkdirSync(g,{recursive:!0});let y=await d.Open.file(h),S=null;for(let v of y.files)if(v.path==="menus.json"){let w=await v.buffer();S=JSON.parse(w.toString("utf8"))}else if(v.path.startsWith("media/")){let w=T.basename(v.path),I=T.join(g,w);F.existsSync(I)&&F.unlinkSync(I);let _=await v.buffer();F.writeFileSync(I,_)}if(!S)return F.unlinkSync(h),e.status(400).json({error:"Invalid ZIP file: menus.json not found"});i=S.menus||[],F.unlinkSync(h)}else if(f===".json"){let d=F.readFileSync(h,"utf8"),g=JSON.parse(d);i=Array.isArray(g)?g:g.menus||[],F.unlinkSync(h)}else return F.unlinkSync(h),e.status(400).json({error:"Invalid file type. Please upload a .zip or .json file"})}else if(t.body.menus)i=t.body.menus;else return e.status(400).json({error:"No file or data provided"});if(!Array.isArray(i))return e.status(400).json({error:"Menus must be an array"});let r=0,a=0,l=0,u=[],c=process.env.UPLOAD_DIR||"./uploads",m=t.body.applyToAllSessions==="true"?Array.from(s.sessions.values()).map(h=>h.client):[n];console.log(`[Import] Applying to ${m.length} session(s)`),i.forEach((h,f)=>{if(!h.name){u.push(`Menu ${f+1}: Missing name`),a++;return}h.mediaPaths&&Array.isArray(h.mediaPaths)&&(h.mediaPaths=h.mediaPaths.map(d=>{if(d&&!d.startsWith("http")){let g=T.basename(d);return T.join(c,g)}return d})),h.options&&Array.isArray(h.options)&&h.options.forEach(d=>{d.mediaPaths&&Array.isArray(d.mediaPaths)&&(d.mediaPaths=d.mediaPaths.map(g=>{if(g&&!g.startsWith("http")){let y=T.basename(g);return T.join(c,y)}return g}))}),m.forEach((d,g)=>{let y=d.interactiveMenus.findIndex(S=>S.name===h.name);if(y!==-1){let S=d.interactiveMenus[y],v={...h,id:S.id,createdAt:S.createdAt,updatedAt:new Date().toISOString(),isActive:h.isActive!==void 0?h.isActive:!0,options:h.options||[]};d.interactiveMenus[y]=v,g===0&&(l++,console.log(`[Import] Replaced existing menu: ${h.name}`))}else{let S={...h,id:h.id||Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),createdAt:h.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:h.isActive!==void 0?h.isActive:!0,options:h.options||[]};d.interactiveMenus.push(S),g===0&&(r++,console.log(`[Import] Created new menu: ${h.name} with ID: ${S.id}`))}})}),m.forEach(h=>{h.saveInteractiveMenus()}),e.json({success:!0,imported:r,replaced:l,skipped:a,total:i.length,errors:u.length>0?u:void 0})}catch(s){console.error("Error importing menus:",s),e.status(500).json({error:s.message})}});var Es=K;import Pt from"express";import Ps from"multer";import R from"path";import x from"fs";import Dt from"archiver";import Rt from"unzipper";import{fileURLToPath as xt}from"url";var Ct=xt(import.meta.url),Ae=R.dirname(Ct),B=Pt.Router(),re=t=>{let e=t.app.get("sessionManager");return t.sessionId||e.getFirstActiveSession(t.userId)};B.get("/status",(t,e)=>{try{let s=t.app.get("sessionManager"),o=re(t);if(!o)return e.json({success:!0,status:"no_session",isReady:!1});let n=s.getSessionClient(o);if(!n)return e.json({success:!0,status:"not_found",isReady:!1});let i=n.getStatus();e.json({success:!0,...i})}catch(s){console.error("Error getting status:",s),e.status(500).json({error:s.message})}});B.get("/qr",(t,e)=>{try{let s=t.app.get("sessionManager"),o=re(t);if(!o)return e.status(404).json({success:!1,error:"No session"});let n=s.getSessionClient(o);if(!n)return e.status(404).json({success:!1,error:"Client not found"});let i=n.getQrCode();if(!i)return e.status(404).json({success:!1,error:"No QR available"});e.json({success:!0,qr:i})}catch(s){console.error("Error getting QR:",s),e.status(500).json({error:s.message})}});B.get("/config",(t,e)=>{try{let s=t.app.get("sessionManager"),o=re(t);if(!o)return e.json({success:!0,config:{headless:!0,messageDelay:2,maxContactsPerBatch:50,waitTimeBetweenBatches:15}});let n=s.getSessionClient(o);if(!n)return e.json({success:!0,config:{}});e.json({success:!0,config:n.config})}catch(s){console.error("Error getting config:",s),e.status(500).json({error:s.message})}});B.post("/config",(t,e)=>{try{let s=t.app.get("sessionManager"),o=re(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=s.getSessionClient(o);if(!n)return e.status(400).json({error:"WhatsApp client not found"});let i=t.body;n.config={...n.config,...i},n.saveConfig(),e.json({success:!0,config:n.config})}catch(s){console.error("Error updating config:",s),e.status(500).json({error:s.message})}});B.post("/initialize",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=re(t);if(!o)return e.status(400).json({error:"No active WhatsApp session to initialize"});await s.initializeSession(o),e.json({success:!0,message:"WhatsApp client initialized"})}catch(s){console.error("Error initializing:",s),e.status(500).json({error:s.message})}});B.post("/logout",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=re(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});let n=await s.destroySession(o);n.success?e.json({success:!0,message:"Logged out successfully"}):e.status(500).json({error:n.error||"Failed to logout"})}catch(s){console.error("Error logging out:",s),e.status(500).json({error:s.message})}});B.post("/reset-session",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=re(t);if(!o)return e.status(400).json({error:"No active WhatsApp session"});console.log(`\u{1F501} Resetting WhatsApp session ${o}...`);let n=s.getSessionClient(o);n?await n.resetSession():await s.destroySession(o),e.json({success:!0,message:"Session cleared. Please scan the new QR."})}catch(s){console.error("Error resetting session:",s),e.status(500).json({error:s.message})}});var kt=Ps.diskStorage({destination:(t,e,s)=>{let o="./uploads/temp";x.existsSync(o)||x.mkdirSync(o,{recursive:!0}),s(null,o)},filename:(t,e,s)=>{s(null,Date.now()+"-"+e.originalname)}}),$t=Ps({storage:kt});B.get("/config/export-all",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=t.query.sessionId||t.sessionId||s.getFirstActiveSession(t.userId);if(!o)return e.status(404).json({error:"No active session found"});let n=s.getSession(o);if(!n)return e.status(404).json({error:"Session not found"});let i=n.client,r=i.interactiveMenus||[],a=i.autoReplyRules||[];console.log("[Export-All] Starting complete export:",{sessionId:o,menusCount:r.length,rulesCount:a.length});let l=new Set,u=process.env.UPLOAD_DIR||"./uploads";r.forEach(d=>{d.mediaPaths&&Array.isArray(d.mediaPaths)&&d.mediaPaths.forEach(g=>{if(g&&!g.startsWith("http")){let y=R.basename(g),S=R.join(u,y);x.existsSync(S)&&l.add(y)}}),d.options&&Array.isArray(d.options)&&d.options.forEach(g=>{g.mediaPaths&&Array.isArray(g.mediaPaths)&&g.mediaPaths.forEach(y=>{if(y&&!y.startsWith("http")){let S=R.basename(y),v=R.join(u,S);x.existsSync(v)&&l.add(S)}})})}),a.forEach(d=>{d.mediaPaths&&Array.isArray(d.mediaPaths)&&d.mediaPaths.forEach(g=>{if(g&&!g.startsWith("http")){let y=R.basename(g),S=R.join(u,y);x.existsSync(S)&&l.add(y)}})}),console.log(`[Export-All] Found ${l.size} media files`);let c=Dt("zip",{zlib:{level:9}}),m=`whatsapp-config-${new Date().toISOString().replace(/[:.]/g,"-")}.zip`;e.attachment(m),c.pipe(e);let h={menus:r,exportDate:new Date().toISOString(),count:r.length,version:"1.0"};c.append(JSON.stringify(h,null,2),{name:"menus.json"});let f={rules:a,exportDate:new Date().toISOString(),count:a.length,version:"1.0"};c.append(JSON.stringify(f,null,2),{name:"rules.json"});for(let d of l){let g=R.join(u,d);x.existsSync(g)&&c.file(g,{name:`media/${d}`})}await c.finalize(),console.log("[Export-All] Export completed successfully")}catch(s){console.error("[Export-All] Error:",s),e.status(500).json({error:s.message})}});B.post("/config/import-all",$t.single("file"),async(t,e)=>{try{let s=t.app.get("sessionManager"),o=t.body.sessionId||t.sessionId||s.getFirstActiveSession(t.userId),n=t.body.applyToAllSessions==="true";if(console.log("[Import-All] Starting complete import:",{sessionId:o,applyToAllSessions:n,fileName:t.file?.originalname}),!t.file)return e.status(400).json({error:"No file uploaded"});let i=s.getSession(o);if(!i)return e.status(404).json({error:"Session not found"});let r=t.file.path,a=process.env.UPLOAD_DIR||"./uploads";x.existsSync(a)||x.mkdirSync(a,{recursive:!0});let l=await Rt.Open.file(r),u=null,c=null,p=0;for(let d of l.files)if(d.path==="menus.json"){let g=await d.buffer(),y=JSON.parse(g.toString("utf8"));u=Array.isArray(y)?y:y.menus||[]}else if(d.path==="rules.json"){let g=await d.buffer(),y=JSON.parse(g.toString("utf8"));c=Array.isArray(y)?y:y.rules||[]}else if(d.path.startsWith("media/")){let g=R.basename(d.path),y=R.join(a,g);x.existsSync(y)&&x.unlinkSync(y);let S=await d.buffer();x.writeFileSync(y,S),p++}if(x.unlinkSync(r),!u&&!c)return e.status(400).json({error:"No valid configuration found in ZIP file"});let m=i.client,h=n?Array.from(s.sessions.values()).map(d=>d.client):[m];console.log(`[Import-All] Applying to ${h.length} session(s)`);let f={menus:{imported:0,replaced:0},rules:{imported:0,replaced:0},media:p};u&&u.length>0&&(u.forEach(d=>{d.name&&(d.mediaPaths&&Array.isArray(d.mediaPaths)&&(d.mediaPaths=d.mediaPaths.map(g=>{if(g&&!g.startsWith("http")){let y=R.basename(g);return R.join(a,y).replace(/\\/g,"/")}return g})),d.options&&Array.isArray(d.options)&&d.options.forEach(g=>{g.mediaPaths&&Array.isArray(g.mediaPaths)&&(g.mediaPaths=g.mediaPaths.map(y=>{if(y&&!y.startsWith("http")){let S=R.basename(y);return R.join(a,S).replace(/\\/g,"/")}return y}))}),h.forEach((g,y)=>{let S=g.interactiveMenus.findIndex(v=>v.name===d.name);if(S!==-1){let v=g.interactiveMenus[S];g.interactiveMenus[S]={...d,id:v.id,createdAt:v.createdAt,updatedAt:new Date().toISOString()},y===0&&f.menus.replaced++}else g.interactiveMenus.push({...d,id:d.id||Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),createdAt:d.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()}),y===0&&f.menus.imported++}))}),h.forEach(d=>{d.saveInteractiveMenus()})),c&&c.length>0&&(c.forEach(d=>{if(!d.name||!d.keywords)return;let g=Array.isArray(d.keywords)?d.keywords:[],y=[];d.mediaPaths&&Array.isArray(d.mediaPaths)&&(y=d.mediaPaths.map(v=>{if(v&&!v.startsWith("http")){let w=R.basename(v);return R.join(a,w).replace(/\\/g,"/")}return v}));let S=d.menuId;if(d.type==="menu"&&d.menuId){let v=h[0];if(!v.interactiveMenus.find(I=>String(I.id)===String(d.menuId))){let I=v.interactiveMenus.find(_=>_.isActive);I&&(console.log(`[Import-All] Updating menuId for rule "${d.name}" to ${I.id}`),S=I.id)}}h.forEach((v,w)=>{let I=v.autoReplyRules.findIndex(b=>b.name===d.name),_={name:d.name,keywords:g,response:d.response||"",matchType:d.matchType||"contains",delay:d.delay||2,isActive:d.isActive!==void 0?d.isActive:!0,mediaPaths:y,mediaPath:y[0]||null,captions:d.captions||[],caption:d.captions&&d.captions[0]||d.caption||"",type:d.type||"simple",menuId:S||null};if(I!==-1){let b=v.autoReplyRules[I];v.autoReplyRules[I]={..._,id:b.id},w===0&&f.rules.replaced++}else v.autoReplyRules.push({..._,id:d.id||Date.now().toString()+"-"+Math.round(Math.random()*1e9)}),w===0&&f.rules.imported++})}),h.forEach(d=>{d.saveAutoReplyRules()})),console.log("[Import-All] Import completed:",f),e.json({success:!0,...f})}catch(s){console.error("[Import-All] Error:",s),e.status(500).json({error:s.message})}});B.get("/config/global-sessions",(t,e)=>{try{let s=R.join(Ae,"../data/globalSessionsConfig.json"),o={enabled:!0,activeSessionId:null};x.existsSync(s)&&(o={...o,...JSON.parse(x.readFileSync(s,"utf8"))}),e.json({success:!0,...o})}catch(s){console.error("[Global-Sessions] Error reading config:",s),e.json({success:!0,enabled:!0,activeSessionId:null})}});B.post("/config/global-sessions",(t,e)=>{try{let{enabled:s,activeSessionId:o}=t.body,n=R.join(Ae,"../data/globalSessionsConfig.json"),i=R.join(Ae,"../data");x.existsSync(i)||x.mkdirSync(i,{recursive:!0});let r={enabled:!0,activeSessionId:null};x.existsSync(n)&&(r=JSON.parse(x.readFileSync(n,"utf8"))),s!==void 0&&(r.enabled=s),o!==void 0&&(r.activeSessionId=o),x.writeFileSync(n,JSON.stringify(r,null,2)),console.log("[Global-Sessions] Configuration updated:",r);let a=t.app.get("sessionManager");if(a&&a.sessions)for(let[l,u]of a.sessions.entries()){let c=u.client;c&&typeof c.loadGlobalSessionsConfig=="function"&&(c.loadGlobalSessionsConfig(),console.log(`[Global-Sessions] Reloaded config for session: ${l}`))}e.json({success:!0,...r})}catch(s){console.error("[Global-Sessions] Error saving config:",s),e.status(500).json({error:s.message})}});B.post("/cleanup-orphaned-files",(t,e)=>{try{let s=t.app.get("sessionManager"),o=process.env.UPLOAD_DIR||R.join(Ae,"../uploads"),{sessionId:n,allSessions:i}=t.body,r;if(i)r=As(s,o),console.log("[Cleanup] Global cleanup executed:",r);else if(n){let a=s.getSession(n);if(!a||!a.client)return e.status(404).json({error:"Session not found"});r=ee(a.client,o),console.log(`[Cleanup] Session ${n} cleanup executed:`,r)}else return e.status(400).json({error:"Must specify sessionId or allSessions=true"});e.json({success:!0,...r,message:`Cleanup complete: ${r.deletedCount} orphaned file(s) deleted`})}catch(s){console.error("[Cleanup] Error:",s),e.status(500).json({error:s.message})}});var Ds=B;q();import Tt from"express";var U=Tt.Router(),H=async(t,e,s)=>{try{let o=await E.getCurrentUser(),n=(o?.subscription_type||"").toString().toLowerCase()==="administrador";if(!o||!n)return e.status(403).json({error:"Acceso denegado. Solo administradores pueden acceder a esta funcionalidad."});s()}catch(o){console.error("Error en requireAdmin:",o),e.status(500).json({error:o.message})}};U.get("/",H,async(t,e)=>{try{let s=await E.getAllUsers();e.json({success:!0,users:s})}catch(s){console.error("Error getting users:",s),e.status(500).json({error:s.message})}});U.get("/current",async(t,e)=>{try{let s=await E.getCurrentUser(),o=await Y.getSubscriptionInfo(s.id);e.json({success:!0,user:s,subscriptionInfo:o})}catch(s){console.error("Error getting current user:",s),e.status(500).json({error:s.message})}});U.delete("/bulk",H,async(t,e)=>{try{let{userIds:s}=t.body;if(!Array.isArray(s)||s.length===0)return e.status(400).json({error:"userIds must be a non-empty array"});let o={success:0,failed:0,errors:[]};for(let n of s)try{let i=parseInt(n);if(isNaN(i)){o.failed++,o.errors.push(`User ${n}: Invalid ID`);continue}await E.deleteUser(i),o.success++}catch(i){o.failed++,o.errors.push(`User ${n}: ${i.message}`)}e.json({success:!0,message:`Deleted ${o.success} user(s)`,results:o})}catch(s){console.error("Error deleting users:",s),e.status(500).json({error:s.message})}});U.get("/:id",async(t,e)=>{try{let s=await E.getUserById(parseInt(t.params.id));if(!s)return e.status(404).json({error:"User not found"});let o=await Y.getSubscriptionInfo(s.id);e.json({success:!0,user:s,subscriptionInfo:o})}catch(s){console.error("Error getting user:",s),e.status(500).json({error:s.message})}});U.post("/",H,async(t,e)=>{try{let{username:s,email:o,subscriptionType:n,password:i,subscriptionStartDate:r,subscriptionEndDate:a}=t.body;if(!s)return e.status(400).json({error:"Username is required"});if(!(await O())[n||"gratuito"])return e.status(400).json({error:"Invalid subscription type"});let u=i||"2748curso";try{let c=await E.createUser(s,o,n||"gratuito",u,r||null,a||null);e.json({success:!0,user:c})}catch(c){if(c.message.includes("already been registered")||c.message.includes("unique constraint")||c.message.includes("already exists")){console.log(`[Users] User with email ${o} already exists, fallback to update.`);let p=await E.getUserByEmail(o);if(p){let m={username:s,subscriptionType:n||"gratuito",subscriptionStartDate:r||null,subscriptionEndDate:a||null},h=await E.updateUser(p.id,m);return e.json({success:!0,user:h,message:"Usuario ya exist\xEDa, actualizado correctamente"})}}throw c}}catch(s){console.error("Error in user creation/upsert:",s),e.status(500).json({error:s.message})}});U.put("/:id/subscription",H,async(t,e)=>{try{let{subscriptionType:s,durationDays:o}=t.body;if(!(await O())[s])return e.status(400).json({error:"Invalid subscription type"});let i=await E.updateUserSubscription(parseInt(t.params.id),s,o||null),r=await Y.getSubscriptionInfo(i.id);e.json({success:!0,user:i,subscriptionInfo:r})}catch(s){console.error("Error updating subscription:",s),e.status(500).json({error:s.message})}});U.put("/:id",H,async(t,e)=>{try{let{username:s,email:o,password:n,subscriptionType:i,durationDays:r,subscriptionStartDate:a,subscriptionEndDate:l}=t.body,u=parseInt(t.params.id);if(!await E.getUserById(u))return e.status(404).json({error:"User not found"});let p={};s!==void 0&&(p.username=s),o!==void 0&&(p.email=o),n!==void 0&&(p.password=n),i!==void 0&&(p.subscriptionType=i),r!==void 0&&(p.durationDays=r),a!==void 0&&(p.subscriptionStartDate=a),l!==void 0&&(p.subscriptionEndDate=l);let m=await E.updateUser(u,p),h=await Y.getSubscriptionInfo(m.id);e.json({success:!0,user:m,subscriptionInfo:h})}catch(s){console.error("Error updating user:",s),e.status(500).json({error:s.message})}});U.get("/:id/stats",async(t,e)=>{try{let s=parseInt(t.params.id);if(!await E.getUserById(s))return e.status(404).json({error:"User not found"});let n=await N.getCurrentMonthCount(s),i=await N.getAllMonthlyStats(s),r=await Y.getSubscriptionInfo(s);e.json({success:!0,stats:{currentMonthCount:n,monthlyStats:i,subscriptionInfo:r}})}catch(s){console.error("Error getting user stats:",s),e.status(500).json({error:s.message})}});U.delete("/:id",H,async(t,e)=>{try{await E.deleteUser(parseInt(t.params.id)),e.json({success:!0,message:"User deleted"})}catch(s){console.error("Error deleting user:",s),e.status(500).json({error:s.message})}});U.get("/subscription/limits",async(t,e)=>{try{let s=await O(),o=Object.keys(s).map(n=>{let i=s[n]||{};return{type:n,...i,messages:i.messages===1/0?-1:i.messages}});e.json({success:!0,limits:o})}catch(s){console.error("Error getting subscription limits:",s),e.status(500).json({error:s.message})}});U.put("/subscription/limits/:type",H,async(t,e)=>{try{let{type:s}=t.params,{messages:o,duration:n,price:i}=t.body;if(o===void 0&&n===void 0&&i===void 0)return e.status(400).json({error:"At least one field (messages, duration, price) must be provided"});let r=await we.getByType(s);if(!r)return e.status(404).json({error:`Subscription type ${s} not found`});let a=await we.update(s,{messages:o!==void 0?o:r.messages,duration:n!==void 0?n:r.duration,price:i!==void 0?i:r.price});e.json({success:!0,limit:a})}catch(s){console.error("Error updating subscription limit:",s),e.status(500).json({error:s.message})}});U.get("/subscription/contact-links",H,async(t,e)=>{try{let s=await oe.getAll();e.json({success:!0,links:s})}catch(s){console.error("Error getting contact links:",s),e.status(500).json({error:s.message})}});U.get("/subscription/contact-links/:type",async(t,e)=>{try{let{type:s}=t.params,o=await oe.getByType(s);if(!o)return e.json({success:!0,link:{subscriptionType:s,contactType:"whatsapp_number",contactValue:"51977638887"}});e.json({success:!0,link:o})}catch(s){console.error("Error getting contact link:",s),e.status(500).json({error:s.message})}});U.put("/subscription/contact-links/:type",H,async(t,e)=>{try{let{type:s}=t.params,{contactType:o,contactValue:n}=t.body;if(!o||!n)return e.status(400).json({error:"Missing required fields: contactType, contactValue"});if(!["whatsapp_number","wa_link","payment_link"].includes(o))return e.status(400).json({error:"Invalid contactType. Must be: whatsapp_number, wa_link, or payment_link"});let i=await oe.upsert(s,o,n);e.json({success:!0,link:i})}catch(s){console.error("Error updating contact link:",s),e.status(500).json({error:s.message})}});var Rs=U;q();Re();import Ut from"express";var Ie=Ut.Router();Ie.post("/login",async(t,e)=>{try{let{email:s,password:o}=t.body;if(!s||!o)return e.status(400).json({error:"Email y contrase\xF1a son requeridos"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s))return e.status(400).json({error:"Formato de correo electr\xF3nico inv\xE1lido"});let{data:i,error:r}=await De.auth.signInWithPassword({email:s,password:o});if(r||!i?.user)return await E.getUserByEmail(s)?e.status(401).json({error:"Contrase\xF1a incorrecta"}):e.status(404).json({error:"Usuario no encontrado",message:"No existe una cuenta con este correo electr\xF3nico"});if(!await E.getUserByEmail(s)){let u=s.split("@")[0];try{await E.ensureProfileForAuthUser(i.user.id,u,s)}catch{}}let l=await E.getUserByEmail(s);if(!l)return e.status(500).json({error:"No se pudo cargar el perfil del usuario"});if(l.is_active===!1)return e.status(403).json({error:"Usuario inactivo"});e.json({success:!0,user:l,message:"Login exitoso"})}catch(s){console.error("Error in login:",s),e.status(500).json({error:s.message})}});Ie.post("/change-password",async(t,e)=>{try{let{email:s,currentPassword:o,newPassword:n}=t.body;if(!s||!o||!n)return e.status(400).json({error:"Email, contrase\xF1a actual y nueva contrase\xF1a son requeridos"});if(n.length<6)return e.status(400).json({error:"La nueva contrase\xF1a debe tener al menos 6 caracteres"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s))return e.status(400).json({error:"Formato de correo electr\xF3nico inv\xE1lido"});let{data:r,error:a}=await De.auth.signInWithPassword({email:s,password:o});if(a||!r?.user)return e.status(401).json({error:"La contrase\xF1a actual es incorrecta"});let l=await E.getUserByEmail(s);return l?.auth_user_id?(await E.updateUser(l.id,{password:n}),e.json({success:!0,message:"Contrase\xF1a actualizada correctamente"})):e.status(400).json({error:"El usuario no tiene auth_user_id asociado"})}catch(s){console.error("Error in change-password:",s),e.status(500).json({error:s.message})}});Ie.post("/register",async(t,e)=>{try{let{email:s,password:o}=t.body;if(!s||!o)return e.status(400).json({error:"Email y contrase\xF1a son requeridos"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s))return e.status(400).json({error:"Formato de correo electr\xF3nico inv\xE1lido"});if(await E.getUserByEmail(s))return e.status(409).json({error:"Ya existe una cuenta con este correo electr\xF3nico"});if(o.length<6)return e.status(400).json({error:"La contrase\xF1a debe tener al menos 6 caracteres"});let r=s.split("@")[0],a=await E.createUser(r,s,"gratuito",o);e.json({success:!0,user:a,message:"Cuenta creada exitosamente"})}catch(s){console.error("Error in register:",s),e.status(500).json({error:s.message})}});var xs=Ie;import J from"path";import{fileURLToPath as Nt}from"url";import C from"fs";var Ot=Nt(import.meta.url),Cs=J.dirname(Ot),Ge=class{constructor(e){this.io=e,this.sessions=new Map,this.userSessions=new Map}generateSessionId(e){return`session_${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getFirstActiveSession(e){let s=Number(e),o=this.userSessions.get(s);if(!o||o.size===0)return null;for(let n of o){let i=this.sessions.get(n);if(i&&i.client&&i.client.isReady)return n}return Array.from(o)[0]||null}getSessionStatus(e){let s=this.sessions.get(e);if(!s)return{status:"not_found",isReady:!1};let o=s.client?s.client.getStatus():{};return{status:s.status,isReady:s.client?s.client.isReady:!1,...o}}getSessionAuthDir(e){let s=process.env.SESSION_DIR||J.join(Cs,".baileys_sessions"),o=e.match(/^session_(\d+)_/),n=o?o[1]:"unknown",i=J.join(s,`user_${n}`);C.existsSync(i)||C.mkdirSync(i,{recursive:!0});let r=J.join(i,e);return C.existsSync(r)||C.mkdirSync(r,{recursive:!0}),r}async createSession(e){try{let s=Number(e),o=this.generateSessionId(s),n=this.getSessionAuthDir(o),i=new me(this.io,n,o);i.setActiveUserId(s);let r={client:i,userId:s,phoneNumber:null,status:"initializing",createdAt:new Date,sessionId:o,authDir:n};return this.sessions.set(o,r),this.userSessions.has(s)||this.userSessions.set(s,new Set),this.userSessions.get(s).add(o),this.io.emit("session_created",{sessionId:o,userId:s,status:"initializing",createdAt:r.createdAt}),console.log(`[SessionManager] Created session ${o} for user ${e}`),{success:!0,sessionId:o,status:r.status,createdAt:r.createdAt}}catch(s){return console.error("[SessionManager] Error creating session:",s),{success:!1,error:s.message}}}async initializeSession(e){try{let s=this.sessions.get(e);if(!s)throw new Error("Session not found");if(await s.client.initialize(),s.client.on("connection.update",n=>{let{connection:i,qr:r}=n;if(i==="open"){s.status="connected",this.sessions.set(e,s);let a=s.client.sock?.user?.id,l=a?a.split("@")[0].split(":")[0]:null;l&&(s.phoneNumber=l),this.io.emit("session_updated",{sessionId:e,userId:s.userId,status:"connected",isReady:!0,phoneNumber:l}),console.log(`[SessionManager] Session ${e} connected`)}else if(i==="close"){let a=n.lastDisconnect?.error?.output?.statusCode;a===401||a===403?(console.log(`[SessionManager] Session ${e} logged out. Removing from manager.`),this.destroySession(e).catch(()=>{})):(s.status="disconnected",this.io.emit("session_updated",{sessionId:e,status:"disconnected",isReady:!1}))}else r&&(s.status="waiting_qr",this.io.emit("session_updated",{sessionId:e,status:"waiting_qr",isReady:!1}))}),s.client.isReady||s.client.sock?.ws?.readyState===1){console.log(`[SessionManager] Session ${e} was already connected after init`),s.status="connected",this.sessions.set(e,s);let n=s.client.sock?.user?.id,i=n?n.split(":")[0]:null;this.io.emit("session_updated",{sessionId:e,userId:s.userId,status:"connected",isReady:!0,phoneNumber:i})}return s.status!=="connected"&&(s.status="waiting_qr",this.sessions.set(e,s),this.io.emit("session_updated",{sessionId:e,userId:s.userId,status:"waiting_qr"})),console.log(`[SessionManager] Initialized session ${e}`),{success:!0}}catch(s){return console.error("[SessionManager] Error initializing session:",s),{success:!1,error:s.message}}}getUserSessions(e){let s=Number(e),o=this.userSessions.get(s)||new Set,n=[];for(let i of o){let r=this.sessions.get(i);r&&n.push({sessionId:i,userId:r.userId,phoneNumber:r.phoneNumber,status:r.status,createdAt:r.createdAt,isReady:r.client?.isReady||!1})}return n}getFirstActiveSession(e){let s=Number(e),o=this.userSessions.get(s)||new Set;for(let n of o){let i=this.sessions.get(n);if(i&&(i.status==="connected"||i.client&&i.client.isReady))return n}return null}getAnyActiveSession(){for(let[e,s]of this.sessions.entries())if(s&&(s.status==="connected"||s.client&&s.client.isReady))return e;return null}getAllSessions(){let e=[];for(let[s,o]of this.sessions.entries())e.push({sessionId:s,userId:o.userId,phoneNumber:o.phoneNumber,status:o.status,createdAt:o.createdAt,isReady:o.client?.isReady||!1});return e}getSession(e){return this.sessions.get(e)}getSessionClient(e){return this.sessions.get(e)?.client||null}updateSessionPhone(e,s){let o=this.sessions.get(e);o&&(o.phoneNumber=s,o.status="connected",this.sessions.set(e,o),this.io.emit("session_updated",{sessionId:e,userId:o.userId,phoneNumber:s,status:"connected"}),console.log(`[SessionManager] Updated session ${e} with phone ${s}`))}async sendMessage(e,s,o="",n=null,i=""){let r=this.getSessionClient(e);if(!r||!r.isReady)throw new Error("La sesi\xF3n de WhatsApp no est\xE1 lista o no existe");return await r.sendMessage(s,o,n,i)}async sendBulkMessages(e,...s){let o=this.getSessionClient(e);if(!o||!o.isReady)throw new Error("La sesi\xF3n de WhatsApp no est\xE1 lista o no existe");return await o.sendBulkMessages(...s)}async getGroups(e){let s=this.getSessionClient(e);if(!s||!s.isReady)throw new Error("La sesi\xF3n de WhatsApp no est\xE1 lista o no existe");return await s.getGroups()}async destroySession(e){try{let s=this.sessions.get(e);if(!s)return{success:!1,error:"Session not found"};s.client&&await s.client.destroy(),s.authDir&&C.existsSync(s.authDir)&&C.rmSync(s.authDir,{recursive:!0,force:!0}),this.sessions.delete(e);let o=this.userSessions.get(s.userId);return o&&(o.delete(e),o.size===0&&this.userSessions.delete(s.userId)),this.io.emit("session_destroyed",{sessionId:e,userId:s.userId}),console.log(`[SessionManager] Destroyed session ${e}`),{success:!0}}catch(s){return console.error("[SessionManager] Error destroying session:",s),{success:!1,error:s.message}}}async destroyUserSessions(e){let s=Number(e),o=Array.from(this.userSessions.get(s)||[]),n=[];for(let i of o){let r=await this.destroySession(i);n.push({sessionId:i,...r})}return n}getSessionQR(e){let s=this.sessions.get(e);return!s||!s.client?null:s.client.getQrCode()}async sendMessage(e,s,o,n=null,i=""){let r=this.sessions.get(e);if(!r)throw new Error("Session not found");if(!r.client||!r.client.isReady)throw new Error("Session not ready");return await r.client.sendMessage(s,o,n,i)}async restoreSessions(){try{let e=process.env.SESSION_DIR||J.join(Cs,".baileys_sessions");if(console.log(`[SessionManager] Restoring sessions from: ${e}`),!C.existsSync(e)){console.log("[SessionManager] No sessions directory found");return}let s=C.readdirSync(e);for(let i of s){let r=J.join(e,i);try{if(!C.statSync(r).isDirectory())continue}catch{continue}let a=i.match(/^session_(\d+)_/);if(a){let l=a[1],u=J.join(e,`user_${l}`);C.existsSync(u)||C.mkdirSync(u,{recursive:!0});let c=J.join(u,i);console.log(`[SessionManager] Migrating legacy session ${i} to ${c}`);try{C.renameSync(r,c)}catch(p){console.error(`[SessionManager] Failed to migrate session ${i}:`,p)}}}let o=C.readdirSync(e),n=0;for(let i of o){let r=i.match(/^user_(\d+)$/);if(!r)continue;let a=Number(r[1]),l=J.join(e,i);if(!C.statSync(l).isDirectory())continue;let u=C.readdirSync(l);for(let c of u){let p=J.join(l,c);try{if(!C.statSync(p).isDirectory())continue}catch{continue}let m=c;console.log(`[SessionManager] Restoring session ${m} for user ${a}`);let h=J.resolve(p),f=new me(this.io,h,m);f.setActiveUserId(a);let d={client:f,userId:a,phoneNumber:null,status:"restored",createdAt:new Date,sessionId:m,authDir:h},g=null;try{let y=C.statSync(p);d.createdAt=y.birthtime;let S=J.join(p,"creds.json");if(C.existsSync(S)){let v=JSON.parse(C.readFileSync(S,"utf8"));v.me&&(v.me.id||v.me.jid)&&(g=(v.me.id||v.me.jid).split("@")[0].split(":")[0].replace(/\D/g,""),console.log(`[SessionManager] Found phone ${g} in creds.json for ${m}`))}}catch(y){console.warn(`[SessionManager] Could not read metadata for ${m}:`,y.message)}g&&(d.phoneNumber=g),this.sessions.set(m,d),this.userSessions.has(a)||this.userSessions.set(a,new Set),this.userSessions.get(a).add(m),n++;try{await this.initializeSession(m)}catch(y){console.error(`[SessionManager] Error auto-initializing session ${m}:`,y)}}}console.log(`[SessionManager] Restored total ${n} sessions.`)}catch(e){console.error("[SessionManager] Error restoring sessions:",e)}}},ks=Ge;import Lt from"express";var pe=Lt.Router();pe.get("/",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=t.app.get("userService"),n=t.userId;if(!n)return e.status(401).json({success:!1,error:"Usuario no autenticado"});let i=!1;try{let l=await o.getUserById(n);i=l&&(l.subscription_type||"").toLowerCase()==="administrador"}catch{i=(t.headers["x-user-role"]||"").toLowerCase()==="administrador"}let r,a=t.query.userId;i&&a?r=s.getUserSessions(a):r=s.getUserSessions(n),e.json({success:!0,sessions:r})}catch(s){console.error("[SessionsRoute] Error getting sessions:",s),e.status(500).json({success:!1,error:s.message})}});pe.post("/",async(t,e)=>{try{let s=t.app.get("sessionManager"),o=t.userId;if(!o)return e.status(401).json({success:!1,error:"Usuario no autenticado"});let n=await s.createSession(o);e.json(n)}catch(s){console.error("[SessionsRoute] Error creating session:",s),e.status(500).json({success:!1,error:s.message})}});pe.post("/:sessionId/initialize",async(t,e)=>{try{let s=t.app.get("sessionManager"),{sessionId:o}=t.params,n=await s.initializeSession(o);e.json(n)}catch(s){console.error("[SessionsRoute] Error initializing session:",s),e.status(500).json({success:!1,error:s.message})}});pe.get("/:sessionId/qr",(t,e)=>{try{let s=t.app.get("sessionManager"),{sessionId:o}=t.params,n=s.getSessionQR(o);n?e.json({success:!0,qr:n}):e.json({success:!1,error:"QR no disponible"})}catch(s){console.error("[SessionsRoute] Error getting QR:",s),e.status(500).json({success:!1,error:s.message})}});pe.delete("/:sessionId",async(t,e)=>{try{let s=t.app.get("sessionManager"),{sessionId:o}=t.params,n=await s.destroySession(o);e.json(n)}catch(s){console.error("[SessionsRoute] Error deleting session:",s),e.status(500).json({success:!1,error:s.message})}});var $s=pe;q();Bt.config();var Jt=zt(import.meta.url),Gt=Ve.dirname(Jt),je=process.env.PROFILE_SLUG||null,Zn=process.env.SESSION_DIR||null,Yn=process.env.DATA_DIR||null,Vt=je?Ve.join(process.cwd(),`.${je}-port-info.json`):Ve.join(Gt,"..",".port-info.json"),Us=t=>{try{Qe.writeFileSync(Vt,JSON.stringify(t,null,2),"utf8")}catch(e){console.error("Failed to persist port info:",e.message)}};(async()=>{let t=_e(),e=Wt(t),s=process.env.BACKEND_PORT?parseInt(process.env.BACKEND_PORT,10):null,o=process.env.FRONTEND_PORT?parseInt(process.env.FRONTEND_PORT,10):null,n=s||23456,i=o||12345,r=n,a;try{if(s){if(!await Se(s)){let g=new Error(`Configured BACKEND_PORT ${s} is already in use`);throw g.code="CONFIGURED_PORT_IN_USE",g.port=s,g.portType="backend",g}r=s}else r=await Xe(n);let l=o||i,u=[`http://localhost:${l}`,"http://localhost:12345",process.env.FRONTEND_URL].filter(Boolean);a=new Ts(e,{cors:{origin:u,methods:["GET","POST","PUT","DELETE"],credentials:!0}}),Us({backendPort:r,frontendPort:l}),console.log(`\u{1F50C} Backend will run on port ${r}`),console.log(`\u{1F310} Frontend expected on port ${l}`),t.use(Ft({origin:function(d,g){if(!d)return g(null,!0);u.indexOf(d)!==-1||console.log("CORS blocked origin:",d),g(null,!0)},credentials:!0})),t.use(_e.json()),t.use(_e.urlencoded({extended:!0})),t.use((d,g,y)=>{let S=d.headers["x-user-id"]||d.body&&d.body.userId;S&&(d.userId=parseInt(S));let v=d.headers["x-session-id"]||d.body&&d.body.sessionId;v&&(d.sessionId=v),y()});let c=process.env.UPLOAD_DIR||"./uploads";Qe.existsSync(c)||Qe.mkdirSync(c,{recursive:!0}),t.use("/uploads",_e.static(c));let p=new ks(a);await p.restoreSessions();let m=p,h=new Le(p);t.set("sessionManager",p),t.set("whatsappClient",p),t.set("messageScheduler",h),t.set("userService",E),t.set("messageCountService",N),t.set("validationService",Y),t.set("messageLogService",Z),t.set("subscriptionContactLinksService",oe),t.set("groupSelectionService",$e),t.set("io",a),t.use("/api/sessions",$s),t.use("/api/messages",us),t.use("/api/groups",ys),t.use("/api/contacts",ws),t.use("/api/auto-reply",js),t.use("/api/menus",Es),t.use("/api/users",Rs),t.use("/api/auth",xs),t.use("/api",Ds),t.get("/api/health",(d,g)=>{g.json({status:"ok",timestamp:new Date})}),t.get("/api/status",(d,g)=>{g.json({status:"ok",timestamp:new Date})}),a.on("connection",d=>{console.log("Client connected:",d.id),d.on("select_session",g=>{d.join(`session_${g}`),console.log(`Socket ${d.id} joined session_${g}`);let y=p.getSessionStatus(g);d.emit("session_status",{sessionId:g,...y})}),d.on("user_logged_in",async g=>{g&&g.userId&&console.log(`[Server] Socket ${d.id} logged in as user: ${g.userId}`)}),d.on("disconnect",()=>{console.log("Client disconnected:",d.id)})}),t.use((d,g,y,S)=>{console.error("Error:",d),y.status(500).json({error:"Internal server error",message:d.message})}),e.listen(r,()=>{console.log("================================="),console.log(`\u{1F680} Server running on port ${r}`),console.log(`\u{1F310} Frontend URL: http://localhost:${l}`),console.log(`\u{1F513} CORS Allowed Origins: ${u.join(", ")}`),console.log("\u{1F449} Waiting for manual initialization via frontend button..."),console.log("=================================")});let f=async d=>{console.log(`
Received ${d}, shutting down gracefully...`);try{await m.destroy(),console.log("WhatsApp client disconnected")}catch(g){console.error("Error disconnecting WhatsApp client:",g)}e.close(()=>{console.log("Server closed"),process.exit(0)}),setTimeout(()=>{console.error("Forced shutdown after timeout"),process.exit(1)},1e4)};process.on("SIGINT",()=>f("SIGINT")),process.on("SIGTERM",()=>f("SIGTERM")),typeof global<"u"&&(global.serverIo=a,global.serverWhatsappClient=m)}catch(l){if(console.error("Error initializing server:",l),l.code==="CONFIGURED_PORT_IN_USE"){console.error(`\u274C Cannot start profile${je?` "${je}"`:""}: configured ${l.portType} port ${l.port} is already in use.`),process.exitCode=98;return}r=n;let u=i;a=new Ts(e,{cors:{origin:["http://localhost:12345"],methods:["GET","POST","PUT","DELETE"],credentials:!0}});let c=new me(a),p=new Le(c);Us({backendPort:r,frontendPort:u}),e.listen(r,()=>{console.log("================================="),console.log(`\u{1F680} Server running on port ${r} (fallback)`),console.log("=================================")}),typeof global<"u"&&(global.serverIo=a,global.serverWhatsappClient=c)}})();var Xn=()=>typeof global<"u"?global.serverIo:null,Hn=()=>typeof global<"u"?global.serverWhatsappClient:null;export{Xn as getIo,Hn as getWhatsappClient};
